#LyX 2.1 created this file. For more info see http://www.lyx.org/
\lyxformat 474
\begin_document
\begin_header
\textclass revtex4-1
\options prb
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter default
\font_math auto
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\quotes_language english
\papercolumns 2
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Electron-phonon matrix elements and superconductivity for VASP
\end_layout

\begin_layout Author
A.
\begin_inset space ~
\end_inset

Linscheid
\end_layout

\begin_layout Standard
The electron phonon interaction is computed from the difference in the potential
 that the diplacements of atoms create in the Kohn Sham potential.
 In this document, we describe the technical details how to obtain these
 from an electronic structure code (with the VASP code in mind).
 It is assumed that the reader is familiar with Kohn Sham DFT and (later
 in the document) the Eliashberg theory of superconductivity.
\end_layout

\begin_layout Section
Phonon modes
\end_layout

\begin_layout Standard
According to Migdal's theorem, we can describe the electron-phonon coupling
 in many cases just by considering the bare coupling of electrons to the
 lattice displacements.
 In spite of what the name suggests, the actual bosonic mode that couples
 to the electrons is not a single phonon mode, but the propagator that couples
 to the displacement.
 We will discover that this can be decomposed into phonons.
 As a first step, we start from the Green's function of the displacements
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}(\boldsymbol{R}_{1}\mu_{1}\tau_{1},\boldsymbol{R}_{2}\mu_{2}\tau_{2}) & = & \langle\hat{\underbar{v}}_{\boldsymbol{R}_{1}\mu_{1}}(\tau_{1})\hat{\underbar{v}}_{\boldsymbol{R}_{2}\mu_{2}}(\tau_{2})\rangle\nonumber \\
 &  & -\langle\hat{\underbar{v}}_{\boldsymbol{R}_{1}\mu_{1}}(\tau_{1})\rangle\langle\hat{\underbar{v}}_{\boldsymbol{R}_{2}\mu_{2}}(\tau_{2})\rangle\nonumber \\
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\hat{\underbar{v}}_{\boldsymbol{R}_{p_{1}}\mu_{1}}$
\end_inset

 is the quantized displacement operator.
 Within in the Born-Oppenheimer approximation the motion of the electrons
 is described for static nucleii while the the presence of the electrons
 provide an effective potential for the electrons.
 The term that appears is total energy of the electronic system 
\begin_inset Formula $E(\underbar{R})$
\end_inset

 as a function of all the nuclear coordinates in the lattice 
\begin_inset Formula $\underbar{R}$
\end_inset

.
 In the context of the present work, however, we are concerned mainly with
 the bare displacement propagator.
 This means here we are consider only the first non-vanishing term in the
 electronically screened potential for the nuclei which is the second order
 gradient of the Born-Oppenheimer energy surface
\begin_inset Formula 
\begin{eqnarray}
\hat{H}_{p}^{0} & = & -\sum_{\boldsymbol{R}\mu_{1}}\frac{\partial_{(\boldsymbol{R}_{1}\mu_{1})}^{2}}{2m_{\mu_{1}}}+\frac{1}{2}\sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2})\underbar{v}_{\boldsymbol{R}_{1}\mu_{1}}\underbar{v}_{\boldsymbol{R}_{2}\mu_{2}}\nonumber \\
\label{eq:PhononHamiltonian}
\end{eqnarray}

\end_inset

where the first term in the Taylor series 
\begin_inset Formula $\sim\langle\hat{\underbar{v}}_{\boldsymbol{R}_{1}\mu_{1}}(\tau_{1})\rangle$
\end_inset

 vanishis since we are in a relaxed atomic configuration and the second
 term 
\begin_inset Formula 
\begin{equation}
\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2})=\nabla_{\boldsymbol{r}}[\nabla_{(\boldsymbol{R}_{1}\mu_{1})}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})]\biggr\vert_{\boldsymbol{r}=(\boldsymbol{R}_{2}\mu_{2})}
\end{equation}

\end_inset

is usually called the matrix of interatomic force constants.
 The notation 
\begin_inset Formula $\nabla_{(\boldsymbol{R}_{1}\mu_{1})}$
\end_inset

 means to displace one of the 
\begin_inset Formula $N$
\end_inset

 atoms 
\begin_inset Formula $\alpha$
\end_inset

 in cell 
\begin_inset Formula $\boldsymbol{R}_{1}$
\end_inset

 as measured from the origin in direction 
\begin_inset Formula $x_{i}=x,y$
\end_inset

 or 
\begin_inset Formula $z$
\end_inset

 where we have collected the 
\begin_inset Formula $3N$
\end_inset

 
\begin_inset Formula $\mu_{1}=(\alpha_{1},x_{i})$
\end_inset

.
 
\begin_inset Formula $v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

 is the self-consisten Kohn-Sham potential and if we do not explicitely
 indicate otherwise is meant at the equilibrium nuclear positions 
\begin_inset Formula $v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})\equiv v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r})$
\end_inset

 (we use the [] notation of the dependence in the mathematical sense of
 a functional).
 The formal definition is thus
\begin_inset Formula 
\begin{equation}
\nabla_{(\boldsymbol{R}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})=\lim_{\Delta\rightarrow0}\frac{v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r})-v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}+\Delta\underbar{v}_{\mu\boldsymbol{R}}](\boldsymbol{r})}{\Delta}\label{eq:DerivativePotential}
\end{equation}

\end_inset

Since 
\begin_inset Formula $\nabla_{(\boldsymbol{R}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

 is the potential a lattice perturbation at the point 
\begin_inset Formula $\boldsymbol{R}\mu$
\end_inset

 creates at 
\begin_inset Formula $\boldsymbol{r}$
\end_inset

 and the gradient of the potential is the force on this atom, this matrix
 
\begin_inset Formula $\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2})$
\end_inset

 is easily optained from any electronic structure code.
 Any code that can perform relaxations needs to compute forces on a given
 atom.
 Here, we simple relax and perturb the system and let VASP or any other
 code compute forces.
 Since from definition Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:DerivativePotential"

\end_inset

 we can see that we can shift the lattice by 
\begin_inset Formula $-\boldsymbol{R}$
\end_inset

 and obtain 
\begin_inset Formula $\nabla_{(\boldsymbol{R}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})=\nabla_{(\boldsymbol{0}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}-\boldsymbol{R})$
\end_inset

, which we use to find 
\begin_inset Formula 
\begin{eqnarray}
\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2}) & = & \nabla_{\boldsymbol{r}}[\nabla_{(\boldsymbol{R}_{1}\mu_{1})}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})]\biggr\vert_{\boldsymbol{r}=(\boldsymbol{R}_{2}\mu_{2})}\\
 & = & \nabla_{\boldsymbol{r}}[\nabla_{\tau_{\boldsymbol{0}\mu_{1}}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}-\boldsymbol{R}_{1})]\biggr\vert_{\boldsymbol{r}=(\boldsymbol{R}_{2}\mu_{2})}\\
 & = & \nabla_{\boldsymbol{r}}[\nabla_{\tau_{\boldsymbol{0}\mu_{1}}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})]\biggr\vert_{\boldsymbol{r}=(\boldsymbol{R}_{2}-\boldsymbol{R}_{1}\mu_{2})}\\
 & = & \tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}_{2}-\boldsymbol{R}_{1}\mu_{2})
\end{eqnarray}

\end_inset

so the matrix of force constants fortunately does not depend on the absolute
 position in the lattice.
 In practice, we will calculate it from finite differences
\begin_inset Formula 
\begin{equation}
\boldsymbol{F}_{\mu_{1}\boldsymbol{R}_{1}}=\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{0}\mu_{2})\cdot\Delta v_{\mu_{2}\boldsymbol{0}}\label{eq:DisplacmentForceConnection}
\end{equation}

\end_inset

where 
\begin_inset Formula $\boldsymbol{F}_{\mu_{1}\boldsymbol{R}_{1}}$
\end_inset

 is the force acting on atom 
\begin_inset Formula $\mu_{1}$
\end_inset

 in cell 
\begin_inset Formula $\boldsymbol{R}_{1}$
\end_inset

 due to a displacement 
\begin_inset Formula $\Delta v_{\mu_{2}\boldsymbol{0}}$
\end_inset

 of atom 
\begin_inset Formula $\mu_{2}$
\end_inset

 in cell which we choose as the origin (because of translational invarience).
 To compute 
\begin_inset Formula $\tilde{C}(\boldsymbol{R}\mu_{1},\boldsymbol{0}\mu_{2})$
\end_inset

 one has to apply a supercell method.
 Let the size of the supercell be 
\begin_inset Formula $\boldsymbol{L}$
\end_inset

.
 Then, we have to take into account that displacement in the replica contributes
 to the forces, too and we have
\begin_inset Formula 
\begin{equation}
\boldsymbol{F}_{\alpha_{1}\boldsymbol{R}_{1}}=\sum_{\boldsymbol{L}}\tilde{C}(\boldsymbol{R}_{1}\alpha_{1},\boldsymbol{L}\alpha_{2})\cdot\Delta\boldsymbol{v}_{\alpha_{2}\boldsymbol{L}}
\end{equation}

\end_inset

Let us use
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\tilde{C}_{\Sigma}(\mu_{1}\boldsymbol{R}_{1},\mu_{2}\boldsymbol{0})=\sum_{\boldsymbol{L}}\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{L}\mu_{2})
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Symmetry considerations
\end_layout

\begin_layout Standard
Some 
\begin_inset Formula $\Delta v_{\mu}\equiv u_{\mu}$
\end_inset

 (suppressing the primitive cell index 
\begin_inset Formula $\boldsymbol{R}=\boldsymbol{0}$
\end_inset

) are symmetry equivalent in the sense that the forces induced by such a
 displacement can be calculated from the displacement related by symmetry.
 Let us consider for example a site symmetry at an atomic position.
 A site symmetry is a sub group of the lattice symmetry that leaves the
 particular point invarient.
 Of cause, this exlcudes fractional translations.
 Asumme 
\begin_inset Formula $g_{\alpha}$
\end_inset

 is a matrix representation of a member in such a subgroup at atomic site
 
\begin_inset Formula $\alpha$
\end_inset

 and 
\begin_inset Formula $\boldsymbol{u}_{\alpha}$
\end_inset

 is a displacement vector.
 Then let 
\begin_inset Formula $\boldsymbol{u}_{\alpha}^{\prime}$
\end_inset

 be the image of 
\begin_inset Formula $g_{\alpha}$
\end_inset

.
 The force in the lattice of each atom 
\begin_inset Formula $\alpha_{1}$
\end_inset

 induced by the displacement 
\begin_inset Formula $\boldsymbol{u}_{\alpha}^{\prime}$
\end_inset

 is given by
\begin_inset Formula 
\begin{equation}
\boldsymbol{F}_{\alpha_{1}\boldsymbol{R}_{1}}=g_{\alpha}\cdot\boldsymbol{F}_{U_{\alpha}^{-1}(\alpha^{\prime})}\label{eq:ForceSiteSymmetry}
\end{equation}

\end_inset

where 
\begin_inset Formula $U_{\alpha}^{-1}(\alpha^{\prime})=\alpha_{1}$
\end_inset

 is the effect of the symmetry operation on mapping atomic sites into each
 other.
 Furthermore, let us consider a general symmetry operation 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\{g\vert\tau\}$
\end_inset

 of the lattice and assume that it takes and atom 
\begin_inset Formula $\alpha$
\end_inset

 to an atom 
\begin_inset Formula $(\alpha^{\prime},\boldsymbol{R}^{\prime})=\{g\vert\tau\}(\alpha,\boldsymbol{R})$
\end_inset

.
 It is intuitive that the matrix of force constants has the symmetry
\begin_inset Formula 
\begin{equation}
\tilde{C}_{\Sigma}(\alpha_{1}^{\prime},\boldsymbol{R}^{\prime},\alpha_{2}^{\prime})=g\tilde{C}_{\Sigma}(\alpha_{1}\boldsymbol{R},\alpha_{2})g^{-1}\label{eq:InvarianceForceConstantMatrix}
\end{equation}

\end_inset

since we simply rotate the lattice underneath.
 So we need only to compute displacements that are on 1) non-equivalent
 atoms and 2) cannot be reconstructed by a local site-symmetry.
 We call displacements reducible that are equivalent by symmetry to an irreducib
le one.
 For the arbitrary choice of irreducible we simply take the identity symmetry
 operation as the deciding element.
\end_layout

\begin_layout Subsubsection
Reconstruction of reducible displacements
\end_layout

\begin_layout Standard
Let us walk through the list of non-equivalent atoms.
 For each such atom, let us use the site symmetry to reconstruct the forces.
 Let us call the set of site-irreducible displacements 
\begin_inset Formula $\boldsymbol{u}_{\alpha}$
\end_inset

,
\begin_inset Formula $\tilde{\boldsymbol{u}}_{\alpha}$
\end_inset

 is the a reducible displacement, i.e.
 it is generated by a site symmetry 
\begin_inset Formula $\tilde{\boldsymbol{u}}_{\alpha}=g_{\alpha}\boldsymbol{u}_{\alpha}$
\end_inset

.
 Then we combine Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:InvarianceForceConstantMatrix"

\end_inset

 with 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:DisplacmentForceConnection"

\end_inset

 and find
\begin_inset Formula 
\begin{eqnarray}
\boldsymbol{F}_{\alpha_{1}^{\prime},\boldsymbol{R}^{\prime}} & = & \tilde{C}_{\Sigma}(\alpha_{1}^{\prime},\boldsymbol{R}^{\prime},\alpha)\boldsymbol{u}_{\alpha}\\
\boldsymbol{F}_{\alpha_{1}^{\prime},\boldsymbol{R}^{\prime}} & = & g_{\alpha}^{-1}\tilde{C}_{\Sigma}(\{g_{\alpha}^{-1}\vert\tau\}\alpha_{1}^{\prime},\boldsymbol{R}^{\prime},\{g_{\alpha}^{-1}\vert\tau\}\alpha)g_{\alpha}\boldsymbol{u}_{\alpha}\\
g_{\alpha}\boldsymbol{F}_{\alpha_{1}^{\prime},\boldsymbol{R}^{\prime}} & = & \tilde{C}_{\Sigma}(\alpha_{1}\boldsymbol{R},\alpha)\cdot\tilde{\boldsymbol{u}}_{\alpha}
\end{eqnarray}

\end_inset

Above, we have just used one element of the site symmetry group.
 Using all irreducible displacements of this atom 
\begin_inset Formula $\alpha$
\end_inset

 expanded by all site-symmetry point group elements, enumerated by 
\begin_inset Formula $j$
\end_inset

, we find, also usting Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:ForceSiteSymmetry"

\end_inset


\begin_inset Formula 
\begin{equation}
g_{\alpha}^{j}\boldsymbol{F}_{{g_{\alpha}^{j}}^{-1}(\alpha_{1}\boldsymbol{R})}=\tilde{C}_{\Sigma}(\alpha_{1}\boldsymbol{R},\alpha)\cdot\boldsymbol{u}_{\alpha}^{j}\label{eq:ForceConstantEq}
\end{equation}

\end_inset

which can be used to increase the accuracy, since the system can be overdetermin
ed.
 Introducing 
\begin_inset Formula $U_{\alpha}$
\end_inset

 
\begin_inset Formula 
\begin{equation}
U_{\alpha}=\left(\begin{array}{ccc}
u_{\alpha x}^{j=1} & u_{\alpha x}^{j=2} & \ldots\\
u_{\alpha y}^{1} & u_{\alpha y}^{2} & \ldots\\
u_{\alpha z}^{1} & u_{\alpha z}^{2} & \ldots
\end{array}\right)
\end{equation}

\end_inset

and using the shorthand notation 
\begin_inset Formula $\boldsymbol{F}_{\alpha_{1}}^{j}=g_{\alpha}^{j}\boldsymbol{F}_{{g_{\alpha}^{j}}^{-1}(\alpha_{1}\boldsymbol{R})}$
\end_inset

 
\begin_inset Formula 
\begin{equation}
\mathcal{F}_{\alpha_{1}}=\left(\begin{array}{ccc}
F_{\alpha_{1}x}^{1} & F_{\alpha_{1}x}^{2} & \ldots\\
F_{\alpha_{1}y}^{1} & F_{\alpha_{1}y}^{2} & \ldots\\
F_{\alpha_{1}z}^{1} & F_{\alpha_{1}z}^{2} & \ldots
\end{array}\right)
\end{equation}

\end_inset

Eq.
 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:ForceConstantEq"

\end_inset

 becomes
\begin_inset Formula 
\begin{equation}
\mathcal{F}_{\alpha_{1}}=\tilde{C}_{\Sigma}(\alpha_{1}\boldsymbol{R},\alpha)\cdot U_{\alpha}
\end{equation}

\end_inset

and is solved for the matrix of force constants by
\begin_inset Formula 
\begin{equation}
\mathcal{F}_{\alpha_{1}}\cdot U_{\alpha}^{+}=\tilde{C}_{\Sigma}(\alpha_{1}\boldsymbol{R},\alpha)
\end{equation}

\end_inset

where 
\begin_inset Formula $U_{\alpha}^{+}$
\end_inset

 is the pseudo inverse.
 This procedure is applied to all atoms 
\begin_inset Formula $\alpha_{1}$
\end_inset

 but gives only the irreducible 
\begin_inset Formula $\alpha$
\end_inset

 while the reminder of the matrix elements have to be constructed from
\begin_inset Formula 
\begin{equation}
\tilde{C}_{\Sigma}(\beta,\alpha^{\prime})=g\tilde{C}_{\Sigma}(\{g\vert\tau\}\alpha_{1},\{g\vert\tau\}\alpha)g^{-1}
\end{equation}

\end_inset

that one of the elements of the symmetry group satisfied the above property
 is clear from the definition of 
\begin_inset Formula $\alpha$
\end_inset

 as an irreducible atom while 
\begin_inset Formula $\alpha^{\prime}$
\end_inset

 is an element of the so called star of 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\alpha$
\end_inset

 reached by the symmetry operation 
\begin_inset Formula $\{g\vert\tau\}$
\end_inset

.
 This way we obtain the matrix of force constants for all (reducible) atoms
 in the supercell.
\end_layout

\begin_layout Subsubsection
Phonon structure
\end_layout

\begin_layout Standard
In the previous section, we have used the matrix of force constants in the
 supercell.
 The dynamical matrix, however, is related to the matrix of force constants
 in the infinite lattice.
 In the units of the primitive cell, the previous matrix reads
\begin_inset Formula 
\begin{equation}
\tilde{C}_{\Sigma}(\mu_{1}\boldsymbol{R}_{1},\mu_{2}\boldsymbol{0})\equiv\tilde{C}_{\Sigma}(\mu_{1}\boldsymbol{R}_{1}+\boldsymbol{L},\mu_{2}\boldsymbol{L}^{\prime})
\end{equation}

\end_inset

In order to make it approximately equivalent to the results for the infinite
 cell, we move the reference window with a given atom, so that each atom
 have the same number of nearest neighbours.
 This must also include the atoms on the border so we define the extendet
 set of 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 vectors
\begin_inset Formula 
\begin{equation}
R_{x_{i}}\in M_{x_{i}}=\begin{cases}
[-\frac{L_{x_{i}}}{2},\frac{L_{x_{i}}}{2}] & \;{\rm for}\;L_{x_{i}}\;{\rm even}\\{}
[-\frac{L_{x_{i}}+1}{2},\frac{L_{x_{i}}-1}{2}] & \;{\rm for}\;L_{x_{i}}\;{\rm odd}
\end{cases}
\end{equation}

\end_inset

Note that 
\begin_inset Formula $\tilde{C}_{\Sigma}$
\end_inset

 already includes the effect of replicated atoms that induce forces and
 thus 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 vectors on the border of the cell double count because e.g.
\begin_inset space ~
\end_inset

atoms seperated by 
\begin_inset Formula $\boldsymbol{L}$
\end_inset

 are in fact the same atom.
 Thus we need to introduce the weight factor 
\begin_inset Formula $w_{\boldsymbol{R}}$
\end_inset

 that counters this multiplicity
\begin_inset Formula 
\begin{equation}
\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}\mu_{2})\approx\begin{cases}
w_{\boldsymbol{R}}\tilde{C}_{\Sigma}(\mu_{1}\boldsymbol{0},\mu_{2}\boldsymbol{R}) & \boldsymbol{R}\in\boldsymbol{M}\\
0 & {\rm else}
\end{cases}
\end{equation}

\end_inset


\begin_inset Formula $w_{\boldsymbol{R}}$
\end_inset

 is 1 for all interior vectors, 1/2 for border surfaces, 1/4 for edges and
 1/8 for corner points, because the atoms in this position are included
 by these number of periodic replicas.
 With this understanding, we drop the nomenclature 
\begin_inset Formula $w_{\boldsymbol{R}}\tilde{C}_{\Sigma}(\mu_{1}\boldsymbol{0},\mu_{2}\boldsymbol{R})$
\end_inset

 and continue with the label for the infinite quantitiy.
 We introduce the half Fourier transform (of just one of the two 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 coordinates) 
\begin_inset Formula 
\begin{eqnarray}
\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2}) & = & \sum_{\boldsymbol{R}=\boldsymbol{R}_{2}-\boldsymbol{R}_{1}}\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}_{2}-\boldsymbol{R}_{1}\mu_{2}){\rm e}^{-{\rm i}\boldsymbol{q}(\boldsymbol{R}_{2}-\boldsymbol{R}_{1})}\nonumber \\
\\
\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}_{2}-\boldsymbol{R}_{1}\mu_{2}) & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}}\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2}){\rm e}^{{\rm i}\boldsymbol{q}(\boldsymbol{R}_{2}-\boldsymbol{R}_{1})}
\end{eqnarray}

\end_inset

which leads to
\begin_inset Formula 
\begin{eqnarray}
 &  & \sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2})\underbar{v}_{\boldsymbol{R}_{1}\mu_{1}}\underbar{v}_{\boldsymbol{R}_{2}\mu_{2}}=\nonumber \\
 & = & \sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}}\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2}){\rm e}^{{\rm i}\boldsymbol{q}(\boldsymbol{R}_{2}-\boldsymbol{R}_{1})}\underbar{v}_{\boldsymbol{R}_{1}\mu_{1}}\underbar{v}_{\boldsymbol{R}_{2}\mu_{2}}\nonumber \\
\\
 & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\mu_{1}\mu_{2}}\sum_{\boldsymbol{q}}\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})\underbar{v}_{\mu_{1}}(-\boldsymbol{q})\underbar{v}_{\mu_{2}}(\boldsymbol{q})
\end{eqnarray}

\end_inset

with
\begin_inset Formula 
\begin{eqnarray}
\underbar{v}_{\mu}(\boldsymbol{q}) & = & \sum_{\boldsymbol{R}}\underbar{v}_{\boldsymbol{R}\mu}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\\
u_{\nu\boldsymbol{q}} & = & \sum_{\mu}\sqrt{m_{\nu}}C_{\boldsymbol{q}\nu\mu}^{-1}\underbar{v}_{\mu}(\boldsymbol{q})\\
 &  & =\sum_{\boldsymbol{R}\mu}\sqrt{m_{\mu}}C_{\boldsymbol{q}\nu\mu}^{-1}\underbar{v}_{\boldsymbol{R}\mu}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\label{eq:DisplacementWannier}
\end{eqnarray}

\end_inset

note that because 
\begin_inset Formula $\underbar{v}_{\boldsymbol{R}\mu}$
\end_inset

 is real 
\begin_inset Formula $\underbar{v}_{\mu}(-\boldsymbol{q})=[\underbar{v}_{\mu}(\boldsymbol{q})]^{\ast}$
\end_inset

.
 
\begin_inset Formula $C_{\boldsymbol{q}\nu\mu}^{-1}$
\end_inset

 is the so called dynamical matrix.
 We introduce it here as a (yet undetermined) unitary matrix that we will
 chose later to diagonalize the bare Hamiltonian into eigenmodes.
 Now introducing the bosonic operators 
\begin_inset Formula 
\begin{eqnarray}
\hat{b}_{\boldsymbol{q}\nu} & = & \frac{N_{\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}+\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}}{\sqrt{2\varOmega_{\boldsymbol{q}\nu}N_{\boldsymbol{q}}}}\label{eq:PhononOp}\\
\hat{b}_{\boldsymbol{q}\nu}^{\dagger} & = & \frac{-N_{\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}^{\ast}+\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}^{\ast}}{\sqrt{2\varOmega_{\boldsymbol{q}\nu}N_{\boldsymbol{q}}}}\label{eq:PhononOpDag}
\end{eqnarray}

\end_inset

with 
\begin_inset Formula 
\begin{equation}
\hat{P}_{\boldsymbol{q}\nu}=\frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{R}\mu}\frac{C_{\boldsymbol{q}\mu\nu}}{\sqrt{m_{\mu}}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\partial_{(\boldsymbol{R}\mu)}
\end{equation}

\end_inset

which leads to
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{widetext}
\end_layout

\end_inset


\begin_inset Formula 
\begin{eqnarray}
\hat{P}_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}} & = & \frac{1}{N_{\boldsymbol{q}}}[\sum_{\boldsymbol{R}_{2}\mu_{2}}\partial_{(\boldsymbol{R}_{2}\mu_{2})}\frac{C_{\boldsymbol{q}\mu_{2}\nu}}{\sqrt{m_{\mu_{2}}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}_{2}}]u_{\nu\boldsymbol{q}}+u_{\nu\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}\\
 & = & \frac{1}{N_{\boldsymbol{q}}}[\sum_{\boldsymbol{R}_{2}\mu_{2}}\sum_{\boldsymbol{R}\mu}C_{\boldsymbol{q}\nu\mu}^{-1}C_{\boldsymbol{q}\mu_{2}\nu}\partial_{(\boldsymbol{R}_{2}\mu_{2})}\underbar{v}_{\boldsymbol{R}\mu}\times\nonumber \\
 &  & \times\sqrt{\frac{m_{\mu}}{m_{\mu_{2}}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}-\boldsymbol{R}_{2})}]+u_{\nu\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}\\
 & = & \sum_{\mu_{2}}C_{\boldsymbol{q}\nu\mu_{2}}^{\dagger}C_{\boldsymbol{q}\mu_{2}\nu}+u_{\nu\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}\\
 & = & 1+u_{\nu\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}
\end{eqnarray}

\end_inset

where we have used 
\begin_inset Formula $\partial_{(\boldsymbol{R}_{2}\mu_{2})}\underbar{v}_{\boldsymbol{R}\mu}=\delta_{\mu_{2}\mu}\delta_{\boldsymbol{R},\boldsymbol{R}_{2}}$
\end_inset

 such that also 
\begin_inset Formula $[\hat{P}_{\boldsymbol{q}\nu},u_{\nu\boldsymbol{q}}]_{-}=1$
\end_inset

.
 Further 
\begin_inset Formula 
\begin{eqnarray}
\sum_{\boldsymbol{q}\nu}\hat{P}_{\boldsymbol{q}\nu}\hat{P}_{\boldsymbol{q}\nu}^{\ast} & = & \sum_{\boldsymbol{q}\nu}\frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\frac{C_{\boldsymbol{q}\mu_{1}\nu}}{\sqrt{m_{\mu_{1}}}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}_{1}}\partial_{(\boldsymbol{R}_{1}\mu_{1})}\frac{C_{\boldsymbol{q}\mu_{2}\nu}^{\ast}}{\sqrt{m_{\mu_{2}}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}_{2}}\partial_{(\boldsymbol{R}_{2}\mu_{2})}\\
 & = & \frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\sum_{\boldsymbol{q}\nu}\frac{C_{\boldsymbol{q}\mu_{2}\nu}C_{\boldsymbol{q}\nu\mu_{2}}^{\dagger}}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}_{1}-\boldsymbol{R}_{2})}\partial_{(\boldsymbol{R}_{1}\mu_{1})}\partial_{(\boldsymbol{R}_{2}\mu_{2})}\\
 & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{R}_{1}\mu_{1}}\frac{\partial_{(\boldsymbol{R}_{1}\mu_{1})}^{2}}{m_{\mu_{1}}}
\end{eqnarray}

\end_inset

So we can see
\begin_inset Formula 
\begin{eqnarray}
\sum_{\boldsymbol{q}\nu}\varOmega_{\boldsymbol{q}\nu}\hat{b}_{\boldsymbol{q}\nu}^{\dagger}\hat{b}_{\boldsymbol{q}\nu} & = & \sum_{\boldsymbol{q}\nu}\frac{1}{2N_{\boldsymbol{q}}}(-N_{\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}+\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}^{\ast})(N_{\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}^{\ast}+\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}})\\
 & = & -N_{\boldsymbol{q}}\sum_{\boldsymbol{q}\nu}\hat{P}_{\boldsymbol{q}\nu}\hat{P}_{\boldsymbol{q}\nu}^{\ast}+\frac{1}{2N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}\nu}\varOmega_{\boldsymbol{q}\nu}^{2}\vert u\vert_{\nu\boldsymbol{q}}^{2}-\sum_{\boldsymbol{q}\nu}\frac{\varOmega_{\boldsymbol{q}\nu}}{2}[\hat{P}_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}-u_{\nu\boldsymbol{q}}^{\ast}\hat{P}_{\boldsymbol{q}\nu}^{\ast}]\\
 & = & -\frac{\partial_{(\boldsymbol{R}_{1}\mu_{1})}^{2}}{2m_{\mu_{1}}}+\frac{1}{2N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}\nu}(\varOmega_{\boldsymbol{q}\nu}^{2}\vert u\vert_{\nu\boldsymbol{q}}^{2}-\varOmega_{\boldsymbol{q}\nu})-\sum_{\boldsymbol{q}\nu}\frac{\varOmega_{\boldsymbol{q}\nu}}{2}[u_{\nu\boldsymbol{q}}\hat{P}_{\boldsymbol{q}\nu}-u_{-\boldsymbol{q}\nu}\hat{P}_{-\boldsymbol{q}\nu}]\\
 & = & -\frac{\partial_{(\boldsymbol{R}_{1}\mu_{1})}^{2}}{2m_{\mu_{1}}}+\sum_{\boldsymbol{q}\nu}\sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\frac{1}{2N_{\boldsymbol{q}}}(\varOmega_{\boldsymbol{q}\nu}^{2}\sqrt{m_{\mu_{1}}m_{\mu_{2}}}C_{\boldsymbol{q}\nu\mu_{1}}^{-1\ast}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}_{2}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}_{1}}C_{\boldsymbol{q}\nu\mu_{2}}^{-1}\underbar{v}_{\boldsymbol{R}_{1}\mu_{1}}\underbar{v}_{\boldsymbol{R}_{2}\mu_{2}}-\frac{1}{2}\varOmega_{\boldsymbol{q}\nu})
\end{eqnarray}

\end_inset

or put differently
\begin_inset Formula 
\begin{equation}
\sum_{\boldsymbol{q}\nu}\varOmega_{\boldsymbol{q}\nu}(\hat{b}_{\boldsymbol{q}\nu}^{\dagger}\hat{b}_{\boldsymbol{q}\nu}+\frac{1}{2})=-\frac{\partial_{(\boldsymbol{R}_{1}\mu_{1})}^{2}}{2m_{\mu_{1}}}+\sum_{\boldsymbol{R}_{1}\mu_{1}}\sum_{\boldsymbol{R}_{2}\mu_{2}}\tilde{C}(\boldsymbol{R}_{1}\mu_{1},\boldsymbol{R}_{2}\mu_{2})\underbar{v}_{\boldsymbol{R}_{1}\mu_{1}}\underbar{v}_{\boldsymbol{R}_{2}\mu_{2}}
\end{equation}

\end_inset

provided that 
\begin_inset Formula 
\begin{eqnarray}
\frac{\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}_{2}-\boldsymbol{R}_{1}\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}} & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}\nu}\varOmega_{\boldsymbol{q}\nu}^{2}C_{\boldsymbol{q}\nu\mu_{1}}^{-1\ast}C_{\boldsymbol{q}\nu\mu_{2}}^{-1}{\rm e}^{{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}_{1}-\boldsymbol{R}_{2})}\label{eq:MatrixForceConstantsInterpol}\\
\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}} & = & \sum_{\nu}C_{\boldsymbol{q}\mu_{1}\nu}\varOmega_{\boldsymbol{q}\nu}^{2}C_{\boldsymbol{q}\nu\mu_{2}}^{\dagger}\label{eq:DynamicalMatrixForceConstantConnection}
\end{eqnarray}

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{widetext}
\end_layout

\end_inset

where we have used 
\begin_inset Formula $\varOmega_{\boldsymbol{q}\nu}=\varOmega_{-\boldsymbol{q}\nu}$
\end_inset

 and thus we arrive at the standard result
\begin_inset Formula 
\begin{equation}
\hat{H}_{p}^{0}=\sum_{\boldsymbol{q}\nu}\varOmega_{\boldsymbol{q}\nu}(\hat{b}_{\boldsymbol{q}\nu}^{\dagger}\hat{b}_{\boldsymbol{q}\nu}+\frac{1}{2})
\end{equation}

\end_inset

so that we have to diagonalize 
\begin_inset Formula $\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})/\sqrt{m_{\kappa_{1}}m_{\kappa_{2}}}$
\end_inset

 to compute the sequare of the phonon frequencies 
\begin_inset Formula $\varOmega_{\boldsymbol{q}\nu}^{2}$
\end_inset

.
 The unitary matrix 
\begin_inset Formula $C_{\boldsymbol{q}\mu_{1}\nu}$
\end_inset

 we obtain from this procedure, the dynamical matrix, completes the formalism.
 
\end_layout

\begin_layout Subsubsection
Units
\end_layout

\begin_layout Standard
The quantity 
\begin_inset Formula $\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})/\sqrt{m_{\kappa_{1}}m_{\kappa_{2}}}$
\end_inset

 as computed by VASP has units 
\begin_inset Formula 
\begin{equation}
\frac{{\rm eV}}{{\rm \AA}^{2}{\rm u}}
\end{equation}

\end_inset

where 
\begin_inset Formula ${\rm u}$
\end_inset

 is the unit of atomic mass, i.e.
 the mass of the proton.
 Since 
\begin_inset Formula $C_{\boldsymbol{q}\mu_{1}\nu}$
\end_inset

 and 
\begin_inset Formula $\hat{b}_{\boldsymbol{q}\nu}$
\end_inset

 are dimensionless, 
\begin_inset Formula $\hbar\varOmega_{\boldsymbol{q}\nu}$
\end_inset

 must have the unit of energy, obviously, and thus converting to SI units
\begin_inset Formula 
\begin{eqnarray}
\varOmega_{\boldsymbol{q}\nu} & \sim & \sqrt{\frac{{\rm eV}}{{\rm \AA}^{2}{\rm u}}}=\sqrt{\frac{1.6021766208\times10^{-19}{\rm J}}{1.660539040\times10^{-27}\cdot10^{-20}{\rm m}^{2}\cdot{\rm kg}}}\\
 &  & =\sqrt{\frac{1.6021766208}{1.660539040}}\frac{1}{{\rm s}}\times10^{14}
\end{eqnarray}

\end_inset

The common unit Hz is in units of 
\begin_inset Formula ${\rm rad}/{\rm s}$
\end_inset

 so
\begin_inset Formula 
\begin{eqnarray}
\varOmega_{\boldsymbol{q}\nu} & \sim & \sqrt{\frac{1.6021766208}{1.660539040}}\frac{10^{2}}{2\pi}\;{\rm THz}\\
 &  & \approx15.633304300669519191\;{\rm THz}
\end{eqnarray}

\end_inset

 
\end_layout

\begin_layout Subsection
Phonon velocities
\end_layout

\begin_layout Standard
Let us compute
\begin_inset Formula 
\begin{equation}
\nabla_{\boldsymbol{q}}\varOmega_{\boldsymbol{q}\nu}=\frac{\nabla_{\boldsymbol{q}}(\varOmega_{\boldsymbol{q}\nu}^{2})}{2\varOmega_{\boldsymbol{q}\nu}}=\frac{1}{2\varOmega_{\boldsymbol{q}\nu}}\nabla_{\boldsymbol{q}}[\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}C_{\boldsymbol{q}\mu_{2}\nu}]
\end{equation}

\end_inset

where in the last step we have used Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:DynamicalMatrixForceConstantConnection"

\end_inset

 as
\begin_inset Formula 
\begin{equation}
\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}C_{\boldsymbol{q}\mu_{2}\nu}=\varOmega_{\boldsymbol{q}\nu}^{2}
\end{equation}

\end_inset

using
\begin_inset Formula 
\begin{eqnarray}
\nabla_{\boldsymbol{q}}\sum_{\mu_{1}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}C_{\boldsymbol{q}\mu_{1}\mu} & = & \nabla_{\boldsymbol{q}}\delta_{\nu\mu}\\
\sum_{\mu_{1}}(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger})C_{\boldsymbol{q}\mu_{1}\mu} & = & -\sum_{\mu_{1}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\mu_{1}\mu})
\end{eqnarray}

\end_inset

such that
\begin_inset Formula 
\begin{eqnarray}
\nabla_{\boldsymbol{q}}\varOmega_{\boldsymbol{q}\nu} & = & \frac{1}{2\varOmega_{\boldsymbol{q}\nu}}\{\sum_{\mu_{1}\mu_{2}}(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger})\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}C_{\boldsymbol{q}\mu_{2}\nu}+\nonumber \\
 &  & +\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\mu_{2}\nu})+\nonumber \\
 &  & +\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}[\nabla_{\boldsymbol{q}}\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}]C_{\boldsymbol{q}\mu_{2}\nu}\}\\
 & = & \frac{1}{2\varOmega_{\boldsymbol{q}\nu}}\{\sum_{\mu_{1}}\varOmega_{\boldsymbol{q}\mu_{1}}^{2}[(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger})C_{\boldsymbol{q}\mu_{1}\nu}+C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}(\nabla_{\boldsymbol{q}}C_{\boldsymbol{q}\mu_{1}\nu})]\nonumber \\
 &  & +\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}[\nabla_{\boldsymbol{q}}\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}]C_{\boldsymbol{q}\mu_{2}\nu}\}\\
 & = & \frac{1}{2\varOmega_{\boldsymbol{q}\nu}}\sum_{\mu_{1}\mu_{2}}C_{\boldsymbol{q}\nu\mu_{1}}^{\dagger}\frac{\nabla_{\boldsymbol{q}}\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}C_{\boldsymbol{q}\mu_{2}\nu}
\end{eqnarray}

\end_inset

which is the well known Hellman Fynman theorem.
\end_layout

\begin_layout Standard
We note that we can combine
\begin_inset Formula 
\begin{eqnarray}
\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger} & = & \frac{N_{\boldsymbol{q}}\partial_{\tau_{1}}+\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}}{\sqrt{2\varOmega_{\boldsymbol{q}\nu}N_{\boldsymbol{q}}}}+\nonumber \\
 & + & \frac{-N_{\boldsymbol{q}}\partial_{\tau_{1}}+\varOmega_{-\boldsymbol{q}\nu}u_{\nu-\boldsymbol{q}}^{\ast}}{\sqrt{2\varOmega_{-\boldsymbol{q}\nu}N_{\boldsymbol{q}}}}\\
 & = & \frac{2\varOmega_{\boldsymbol{q}\nu}u_{\nu\boldsymbol{q}}}{\sqrt{2\varOmega_{\boldsymbol{q}\nu}N_{\boldsymbol{q}}}}\\
 & = & \sqrt{\frac{2\varOmega_{\boldsymbol{q}\nu}}{N_{\boldsymbol{q}}}}u_{\nu\boldsymbol{q}}
\end{eqnarray}

\end_inset

Thus, we find the equation of motion
\begin_inset Formula 
\begin{eqnarray}
\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau) & = & [\hat{H}_{p}^{0},u_{\nu\boldsymbol{q}}]_{-}(\tau)\\
 & = & \sqrt{\frac{N_{\boldsymbol{q}}}{2\varOmega_{\boldsymbol{q}\nu}}}[\hat{H}_{p}^{0},\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger}]_{-}(\tau)\\
 & = & \sqrt{\frac{N_{\boldsymbol{q}}}{2\varOmega_{\boldsymbol{q}\nu}}}(-\varOmega_{\boldsymbol{q}\nu}\hat{b}_{\boldsymbol{q}\nu}+\varOmega_{-\boldsymbol{q}\nu}\hat{b}_{-\boldsymbol{q}\nu}^{\dagger})(\tau)\\
 & = & \varOmega_{\boldsymbol{q}\nu}\sqrt{\frac{N_{\boldsymbol{q}}}{2\varOmega_{\boldsymbol{q}\nu}}}(-\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger})(\tau)
\end{eqnarray}

\end_inset

but
\begin_inset Formula 
\begin{eqnarray}
\partial_{\tau}(-\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger})(\tau) & = & [\hat{H}_{p}^{0},-\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger}]_{-}(\tau)\\
 & = & \varOmega_{\boldsymbol{q}\nu}(\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger})(\tau)
\end{eqnarray}

\end_inset

thus
\begin_inset Formula 
\begin{equation}
\partial_{\tau}^{2}u_{\nu\boldsymbol{q}}(\tau)=\varOmega_{\boldsymbol{q}\nu}^{2}u_{\nu\boldsymbol{q}}(\tau)
\end{equation}

\end_inset

The equation of motion for the displacement propagator
\begin_inset Formula 
\begin{equation}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}\tau,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime})=\langle Tu_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}
\end{equation}

\end_inset

is thus simply going to be
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{widetext}
\end_layout

\end_inset


\begin_inset Formula 
\begin{eqnarray}
\partial_{\tau}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}\tau,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime}) & = & \delta(\tau-\tau^{\prime})[u_{\nu\boldsymbol{q}},u_{\nu^{\prime}\boldsymbol{q}^{\prime}}]_{-}+\langle T\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}\\
 & = & \delta(\tau-\tau^{\prime})[\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger},\hat{b}_{\boldsymbol{q}^{\prime}\nu^{\prime}}+\hat{b}_{-\boldsymbol{q}^{\prime}\nu^{\prime}}^{\dagger}]_{-}+\langle T\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}\\
 & = & \delta(\tau-\tau^{\prime})([\hat{b}_{-\boldsymbol{q}\nu}^{\dagger},\hat{b}_{\boldsymbol{q}^{\prime}\nu^{\prime}}]_{-}+[\hat{b}_{\boldsymbol{q}\nu},\hat{b}_{-\boldsymbol{q}^{\prime}\nu^{\prime}}^{\dagger}]_{-})+\langle T\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}\\
 & = & \langle T\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}
\end{eqnarray}

\end_inset

and further
\begin_inset Formula 
\begin{eqnarray}
\partial_{\tau}^{2}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}\tau,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime}) & = & \partial_{\tau}\langle T\partial_{\tau}u_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}\\
 & = & \varOmega_{\boldsymbol{q}\nu}\partial_{\tau}\langle T(-\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger})(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}\\
 & = & \varOmega_{\boldsymbol{q}\nu}[\delta(\tau-\tau^{\prime})[-\hat{b}_{\boldsymbol{q}\nu}+\hat{b}_{-\boldsymbol{q}\nu}^{\dagger},\hat{b}_{\boldsymbol{q}^{\prime}\nu^{\prime}}+\hat{b}_{-\boldsymbol{q}^{\prime}\nu^{\prime}}^{\dagger}]_{-}+\varOmega_{\boldsymbol{q}\nu}\langle Tu_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}]\\
 & = & \varOmega_{\boldsymbol{q}\nu}[-2\delta(\tau-\tau^{\prime})\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}+\varOmega_{\boldsymbol{q}\nu}\langle Tu_{\nu\boldsymbol{q}}(\tau)u_{\nu^{\prime}\boldsymbol{q}^{\prime}}(\tau^{\prime})\rangle_{0}]
\end{eqnarray}

\end_inset

which leads to the equation of motion
\begin_inset Formula 
\begin{equation}
(-\partial_{\tau}^{2}+\varOmega_{\boldsymbol{q}\nu}^{2})D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}\tau,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime})=2\varOmega_{\boldsymbol{q}\nu}\delta(\tau-\tau^{\prime})\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}
\end{equation}

\end_inset

which is easily solved in Fourier space
\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n}) & = & \int_{0}^{\beta}{\rm d}(\tau-\tau^{\prime})D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}0,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime}-\tau){\rm e}^{{\rm i}\nu_{n}(\tau-\tau^{\prime})}\\
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q}0,\nu^{\prime}\boldsymbol{q}^{\prime}\tau^{\prime}-\tau) & = & \frac{1}{\beta}\sum_{n}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n}){\rm e}^{-{\rm i}\nu_{n}(\tau-\tau^{\prime})}
\end{eqnarray}

\end_inset

to yield
\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n}) & = & \frac{2\varOmega_{\boldsymbol{q}\nu}}{\nu_{n}^{2}+\varOmega_{\boldsymbol{q}\nu}^{2}}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}
\end{eqnarray}

\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Note, that it is possible to compute this function in imaginary time space
 analytically.
 We write for 
\begin_inset Formula $\tau=\tau_{2}-\tau_{1}\in[0,\beta[$
\end_inset


\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu,-\boldsymbol{q}\tau) & = & \frac{1}{\beta}\sum_{n}\frac{2\varOmega_{\boldsymbol{q}\nu}}{\nu_{n}^{2}+\varOmega_{\boldsymbol{q}\nu}^{2}}{\rm e}^{-{\rm i}\nu_{n}\tau}\\
 & = & \frac{1}{\beta}\sum_{n}(\frac{1}{{\rm i}\nu_{n}+\varOmega_{\boldsymbol{q}\nu}}-\frac{1}{{\rm i}\nu_{n}-\varOmega_{\boldsymbol{q}\nu}}){\rm e}^{-{\rm i}\nu_{n}\tau}\\
 & = & {\rm e}^{-\varOmega_{\boldsymbol{q}\nu}(\beta-\tau)}n_{\beta}(-\varOmega_{\boldsymbol{q}\nu})+{\rm e}^{\varOmega_{\boldsymbol{q}\nu}(\beta-\tau)}n_{\beta}(\varOmega_{\boldsymbol{q}\nu})\\
 & = & \frac{{\rm e}^{\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}{\rm e}^{-\varOmega_{\boldsymbol{q}\nu}(\beta-\tau)}}{{\rm e}^{-\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}-{\rm e}^{\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}}+\frac{{\rm e}^{-\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}{\rm e}^{\varOmega_{\boldsymbol{q}\nu}(\beta-\tau)}}{{\rm e}^{\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}-{\rm e}^{-\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu}}}\\
 & = & \frac{{\rm e}^{-\frac{\varOmega_{\boldsymbol{q}\nu}}{2}(\beta-2\tau)}+{\rm e}^{\frac{\varOmega_{\boldsymbol{q}\nu}}{2}(\beta-2\tau)}}{{\rm sinh}(\frac{\beta}{2}\varOmega_{\boldsymbol{q}\nu})}\\
 & = & \frac{{\rm cosh}[\varOmega_{\boldsymbol{q}\nu}(\frac{\beta}{2}-\tau)]}{{\rm sinh}(\varOmega_{\boldsymbol{q}\nu}\frac{\beta}{2})}
\end{eqnarray}

\end_inset

Note that because 
\begin_inset Formula $D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\tau)=D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\tau+\beta)$
\end_inset

, if 
\begin_inset Formula $\tau\in[-\beta,0[$
\end_inset

, we use
\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime},-\vert\tau\vert) & = & D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime},\beta-\vert\tau\vert)\\
 & = & \delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}\frac{{\rm cosh}[\varOmega_{\boldsymbol{q}\nu}(\frac{\beta}{2}-\beta+\vert\tau\vert)]}{{\rm sinh}(\varOmega_{\boldsymbol{q}\nu}\frac{\beta}{2})}\\
 & = & \delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}\frac{{\rm cosh}[\varOmega_{\boldsymbol{q}\nu}(\frac{\beta}{2}-\vert\tau\vert)]}{{\rm sinh}(\varOmega_{\boldsymbol{q}\nu}\frac{\beta}{2})}
\end{eqnarray}

\end_inset

so that we actually find for 
\begin_inset Formula $\tau\in[-\beta,\beta[$
\end_inset


\begin_inset Formula 
\begin{equation}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\tau)=\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}\frac{{\rm cosh}[\varOmega_{\boldsymbol{q}\nu}(\frac{\beta}{2}-\vert\tau\vert)]}{{\rm sinh}(\varOmega_{\boldsymbol{q}\nu}\frac{\beta}{2})}
\end{equation}

\end_inset


\end_layout

\end_inset

We can transform this function in to Wannier space 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
 by writing it in the form
\begin_inset Formula 
\begin{eqnarray}
\sum_{\nu_{1}}[(\nu_{n}^{2}+\varOmega_{\nu\boldsymbol{q}}^{2})\delta_{\nu\nu_{1}}]D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n}) & = & 2\varOmega_{\boldsymbol{q}\nu}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}\\
\sum_{\mu_{1}\nu_{2}}[(\nu_{n}^{2}+\varOmega_{\nu\boldsymbol{q}}^{2})\delta_{\nu\nu_{2}}]C_{\boldsymbol{q}\nu_{2}\mu_{1}}^{\dagger}\sum_{\nu_{1}}C_{\boldsymbol{q}\mu_{1}\nu_{1}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n}) & = & 2\varOmega_{\boldsymbol{q}\nu}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}\\
\sum_{\mu_{1}\nu_{2}}\sum_{\nu}C_{\boldsymbol{q}\mu_{2}\nu}[(\nu_{n}^{2}+\varOmega_{\nu\boldsymbol{q}}^{2})\delta_{\nu\nu_{2}}]C_{\boldsymbol{q}\nu_{2}\mu_{1}}^{\dagger}\sum_{\nu_{1}\nu^{\prime}}C_{\boldsymbol{q}\mu_{1}\nu_{1}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n})C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger} & = & \sum_{\nu\nu^{\prime}}C_{\boldsymbol{q}\mu_{2}\nu}2\varOmega_{\boldsymbol{q}\nu}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}\delta_{\nu\nu^{\prime}}C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger}\\
\sum_{\mu_{1}}[\nu_{n}^{2}\delta_{\mu_{2}\mu_{1}}+\frac{\tilde{C}(\boldsymbol{q}\mu_{2},\mu_{1})}{\sqrt{m_{\kappa_{2}}m_{\kappa_{1}}}}]\sum_{\nu_{1}\nu^{\prime}}C_{\boldsymbol{q}\mu_{1}\nu_{1}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n})C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger} & = & \sum_{\nu}C_{\boldsymbol{q}\mu_{2}\nu}2\varOmega_{\boldsymbol{q}\nu}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger}\\
\frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\boldsymbol{q}^{\prime}}\sum_{\mu_{1}}[\nu_{n}^{2}\delta_{\mu_{2}\mu_{1}}+\sum_{\boldsymbol{R}}\frac{\tilde{C}(\boldsymbol{0}\mu_{2},\boldsymbol{R}\mu_{1})}{\sqrt{m_{\kappa_{2}}m_{\kappa_{1}}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}]\sum_{\nu_{1}\nu^{\prime}}C_{\boldsymbol{q}\mu_{1}\nu_{1}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n})C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger}{\rm e}^{-{\rm i}\boldsymbol{q}^{\prime}\cdot\boldsymbol{R}^{\prime}} & = & \frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\boldsymbol{q}^{\prime}}\sum_{\nu}C_{\boldsymbol{q}\mu_{2}\nu}2\varOmega_{\boldsymbol{q}\nu}\delta_{\boldsymbol{q},-\boldsymbol{q}^{\prime}}C_{\boldsymbol{q}^{\prime}\nu\mu_{3}}^{\dagger}{\rm e}^{-{\rm i}\boldsymbol{q}^{\prime}\cdot\boldsymbol{R}^{\prime}}\\
\sum_{\boldsymbol{R}}\sum_{\mu_{1}}[\nu_{n}^{2}\delta_{\mu_{2}\mu_{1}}\delta_{\boldsymbol{R},\boldsymbol{0}}+\frac{\tilde{C}(\boldsymbol{0}\mu_{2},\boldsymbol{R}\mu_{1})}{\sqrt{m_{\kappa_{2}}m_{\kappa_{1}}}}]\frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\boldsymbol{q}^{\prime}}\sum_{\nu_{1}\nu^{\prime}}C_{\boldsymbol{q}\mu_{1}\nu_{1}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu_{1}\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n})C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{3}}^{\dagger}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}{\rm e}^{-{\rm i}\boldsymbol{q}^{\prime}\cdot\boldsymbol{R}^{\prime}} & = & \frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\nu}C_{\boldsymbol{q}\mu_{2}\nu}2\varOmega_{\boldsymbol{q}\nu}C_{-\boldsymbol{q}\nu\mu_{3}}^{\dagger}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}^{\prime}}
\end{eqnarray}

\end_inset


\end_layout

\end_inset

by introducing
\begin_inset Formula 
\begin{eqnarray}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}\mu_{1},\boldsymbol{R}^{\prime}\mu_{2};\nu_{n}) & = & \frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\boldsymbol{q}^{\prime}}\sum_{\nu\nu^{\prime}}\frac{C_{\boldsymbol{q}\mu_{1}\nu}}{\sqrt{m_{\mu_{1}}}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu^{\prime}\boldsymbol{q}^{\prime}\nu_{n})\frac{C_{\boldsymbol{q}^{\prime}\nu^{\prime}\mu_{2}}^{\dagger}}{\sqrt{m_{\mu_{2}}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}{\rm e}^{-{\rm i}\boldsymbol{q}^{\prime}\cdot\boldsymbol{R}^{\prime}}\\
 & = & \frac{1}{N_{\boldsymbol{q}}^{2}}\sum_{\boldsymbol{q}\nu}\frac{C_{\boldsymbol{q}\mu_{1}\nu}C_{\boldsymbol{q}\mu_{2}\nu}}{\sqrt{m_{\kappa_{2}}m_{\kappa_{1}}}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\nu\boldsymbol{q},\nu,-\boldsymbol{q}\nu_{n}){\rm e}^{{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}^{\prime}-\boldsymbol{R})}\\
 & = & \frac{1}{N_{\boldsymbol{q}}}D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}-\boldsymbol{R}^{\prime},\mu_{1}\mu_{2};\nu_{n})
\end{eqnarray}

\end_inset

and
\begin_inset Formula 
\begin{eqnarray}
\varOmega(\boldsymbol{R},\mu_{2}\mu_{3}) & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}\nu}\frac{C_{\boldsymbol{q}\mu_{2}\nu}\varOmega_{\boldsymbol{q}\nu}C_{\boldsymbol{q}\mu_{3}\nu}}{\sqrt{m_{\kappa_{2}}}\sqrt{m_{\kappa_{3}}}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\\
\varOmega(\boldsymbol{q},\mu_{2}\mu_{3}) & = & \sum_{\boldsymbol{R}}\varOmega(\boldsymbol{R},\mu_{2}\mu_{3}){\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}
\end{eqnarray}

\end_inset

we find that 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}\mu_{1},\boldsymbol{R}^{\prime}\mu_{2};\nu_{n})$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit
 obeys the equation of motion
\begin_inset Formula 
\begin{eqnarray}
\sum_{\boldsymbol{R}\mu_{3}}[m_{\mu_{1}}\nu_{n}^{2}\delta_{\mu_{1}\mu_{3}}\delta_{\boldsymbol{R},\boldsymbol{0}}+\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}\mu_{3})]D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}\mu_{3},\boldsymbol{R}^{\prime}\mu_{2};\nu_{n}) & = & \frac{2}{N_{\boldsymbol{q}}}\varOmega(\boldsymbol{R}^{\prime},\mu_{1}\mu_{2})\\
\sum_{\boldsymbol{R}\mu_{3}}[m_{\mu_{1}}\nu_{n}^{2}\delta_{\mu_{1}\mu_{3}}\delta_{\boldsymbol{R},\boldsymbol{0}}+\tilde{C}(\boldsymbol{0}\mu_{1},\boldsymbol{R}\mu_{3})]D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}^{\prime}-\boldsymbol{R}\mu_{3}\mu_{2};\nu_{n}) & = & 2\varOmega(\boldsymbol{R}^{\prime},\mu_{1}\mu_{2})
\end{eqnarray}

\end_inset

Since this becomes a product in Fourier space, we can solve this equation
 by
\begin_inset Formula 
\begin{equation}
D_{{\scriptscriptstyle {\rm ph}}}^{{\rm {\scriptscriptstyle 0}}}(\boldsymbol{R}^{\prime}-\boldsymbol{R}\mu_{1}\mu_{2};\nu_{n})=\frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{q}\mu_{3}}2[m_{\mu_{1}}\nu_{n}^{2}\delta_{\mu_{1}\mu_{3}}+\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{3})]^{-1}\varOmega(\boldsymbol{q},\mu_{3}\mu_{2}){\rm e}^{{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}^{\prime}-\boldsymbol{R})}
\end{equation}

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{widetext}
\end_layout

\end_inset

Note that from Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:DisplacementWannier"

\end_inset

 we see that we can write the displacement wavefunction formally in Fourier
 space 
\begin_inset Formula 
\begin{eqnarray}
\vert\boldsymbol{q}\nu\rangle & = & \sum_{\boldsymbol{R}\mu}\langle\underbar{v}_{\mu\boldsymbol{R}}\vert\boldsymbol{q}\nu\rangle\vert\underbar{v}_{\mu\boldsymbol{R}}\rangle\\
 & = & \sum_{\boldsymbol{R}\mu}C_{\boldsymbol{q}\nu\mu}^{-1}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\underbar{v}_{\boldsymbol{R}\mu}
\end{eqnarray}

\end_inset

On the other hand
\begin_inset Formula 
\begin{equation}
\langle\underbar{v}_{\mu\boldsymbol{R}}\vert\boldsymbol{q}\nu\rangle=\sum_{\mu^{\prime}\boldsymbol{R}^{\prime}}C_{\boldsymbol{q}\nu\mu}^{-1}\delta(\underbar{v}_{\mu\boldsymbol{R}}-\underbar{v}_{\mu^{\prime}\boldsymbol{R}^{\prime}}){\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}^{\prime}}
\end{equation}

\end_inset

yields that the Wannier function of displacements is, in fact, the delta
 function 
\begin_inset Formula $\delta(\underbar{v}_{\mu\boldsymbol{R}}-\underbar{v}_{\mu^{\prime}\boldsymbol{R}^{\prime}})$
\end_inset

 and 
\begin_inset Formula $C_{\boldsymbol{q}\nu\mu}^{-1}$
\end_inset

 takes the role of 
\begin_inset Formula $a_{\boldsymbol{k}i}^{l}$
\end_inset

 in the Wannier formalism for electronic states [Guistino].
\end_layout

\begin_layout Section
Electron-phonon coupling matrix elements
\end_layout

\begin_layout Standard
The coupling of electrons to the perturbation of the lattice centers is
 described by the variation of the potential in real space.
 Note that it is important to compute the displaced potential self-consistently,
 so that the screening (at least within the Kohn-Sham system) of the induced
 dipole is included.
 
\end_layout

\begin_layout Standard
The Kohn Sham potential and the effect of a displacement is formaly written
 as [Guistino Review]
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{widetext}
\end_layout

\end_inset


\begin_inset Formula 
\begin{equation}
v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}\}](\boldsymbol{r})=v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\}](\boldsymbol{r})+\sum_{\kappa\alpha\boldsymbol{R}}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}\bigr\vert_{\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\}}\Delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}
\end{equation}

\end_inset

Equivalently, 
\series bold

\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}=\lim_{\Delta\rightarrow0}\frac{v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\}](\boldsymbol{r})-v_{{\rm {\scriptscriptstyle scf}}}[\ldots,\boldsymbol{\tau}_{\kappa_{1}\boldsymbol{R}_{1}}^{0},\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}^{0}+\Delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}},\boldsymbol{\tau}_{\kappa_{2}\boldsymbol{R}_{2}}^{0},\ldots](\boldsymbol{r})}{\Delta}
\end{equation}

\end_inset


\series default

\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{widetext}
\end_layout

\end_inset

which higheigts that 
\begin_inset Formula $\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})/\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}$
\end_inset

 is not periodic in the lattice, but instead the lattice periodicity allows
 us to write
\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r}+\boldsymbol{R}_{0})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}=\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}-\boldsymbol{R}_{0}}}\label{eq:DisplacementPotentialTranslationInv}
\end{equation}

\end_inset

In fact screening in a metal is usually very good, so that 
\begin_inset Formula $\nabla_{\mu\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{\boldsymbol{R}})$
\end_inset

 is usually very small even for the first non-zero 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

's [Guistino prb].
 In the easiest procedure, we perform supercell calculations, where we choose
 
\begin_inset Formula $N$
\end_inset

 times the originial cell and, in that, displace atoms.
 The cell must be big enough, so that 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\nabla_{\mu\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{R})$
\end_inset

 is zero for all 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 in the middle of the supercell in each direction.
 This states nothing more than that the supercell is big enough to represent
 the localized potential perturbation.
\end_layout

\begin_layout Subsection
Symmetry considerations
\end_layout

\begin_layout Standard
In the following we want to reconstruct the linear displacement potential
 from a set of finite displacement calculations.
 Let 
\begin_inset Formula $\boldsymbol{u}_{\kappa,j\boldsymbol{0}}$
\end_inset

 again be a finite displacement that causes a self-consistent potential
 variation 
\begin_inset Formula $\Delta_{\kappa,j,\boldsymbol{R}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

.
 Here, 
\begin_inset Formula $\boldsymbol{r}$
\end_inset

 is a point in the primitive cell and 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 is a primitive lattice vector so all space is covered.
 
\end_layout

\begin_layout Standard
Assuming a linear relation between potential variation and displacment,
 we have a relation 
\begin_inset Formula 
\begin{equation}
\Delta_{\kappa,j,\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}-\boldsymbol{R})=\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\kappa}(\boldsymbol{r}-\boldsymbol{R})\cdot\boldsymbol{u}_{\alpha,j\boldsymbol{0}}\label{eq:LinearRelationDisplacementPotentialCartesian}
\end{equation}

\end_inset

where each displacement has cartesian components 
\begin_inset Formula $\boldsymbol{u}_{\kappa,j\boldsymbol{0}}=(u_{\kappa,j\boldsymbol{0}}^{x}\;u_{\kappa,j\boldsymbol{0}}^{y}\;u_{\kappa,j\boldsymbol{0}}^{z})^{{\rm T}}$
\end_inset

 and 
\begin_inset Formula $\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\kappa}(\boldsymbol{r}-\boldsymbol{R})$
\end_inset

 is 
\begin_inset Formula 
\begin{equation}
\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\kappa}=(\delta v_{{\rm {\scriptscriptstyle scf}}}^{\kappa x}\;\delta v_{{\rm {\scriptscriptstyle scf}}}^{\kappa y}\;\delta v_{{\rm {\scriptscriptstyle scf}}}^{\kappa z})
\end{equation}

\end_inset

We follow a similar approach as for the matrix of force constants above.
 First is again the insight, that in a realistic supercell calculation,
 the potential change originiates from periodic replica, too, and thus,
 we obtain from the numerical calculation the cumlutative sum
\begin_inset Formula 
\begin{equation}
{\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}(\boldsymbol{r}-\boldsymbol{R})=\sum_{\boldsymbol{L}}\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\kappa}(\boldsymbol{r}-\boldsymbol{R}+\boldsymbol{L})\label{eq:CummulativeSum}
\end{equation}

\end_inset

Atoms 
\begin_inset Formula $\kappa$
\end_inset

 and 
\begin_inset Formula $\kappa^{\prime}$
\end_inset

 that are connected by a symmetry operation 
\begin_inset Formula $\{g\vert\tau\}$
\end_inset

 imply equivalence in the displacement potential originating from a perturbation
 it their sites, similar to Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:InvarianceForceConstantMatrix"

\end_inset


\begin_inset Formula 
\begin{equation}
{\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa^{\prime}}(\boldsymbol{r}-\boldsymbol{R})={\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}\bigl(g^{-1}\cdot(\boldsymbol{r}-\boldsymbol{R})-\tau\bigr)\cdot g\label{eq:SymmetryDisplacementPotential}
\end{equation}

\end_inset

Unsurprisingly, we obtain the same sense of irreducible displacement as
 before for the matrix of force constants.
 In order to improve the accuracy, we can use a similar trick as for the
 matrix of force constants.
 The main difference is that here, we are looking at continus space, rather
 than descrete lattice sites.
 Let us use Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:LinearRelationDisplacementPotentialCartesian"

\end_inset

 for a point in space 
\begin_inset Formula $\boldsymbol{p}_{0}=g_{\kappa}(\boldsymbol{r}-\boldsymbol{R})$
\end_inset

 that is related to the point 
\begin_inset Formula $\boldsymbol{r}-\boldsymbol{R}$
\end_inset

 by a site-symmetry 
\begin_inset Formula $g_{\kappa}$
\end_inset

 of the lattice site 
\begin_inset Formula $\kappa$
\end_inset


\begin_inset Formula 
\begin{equation}
\Delta_{\kappa,j,\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}\bigl(g_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\bigr)=\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\kappa}\bigl(g_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\bigr)\cdot\boldsymbol{u}_{\kappa,j\boldsymbol{0}}
\end{equation}

\end_inset

Now using Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:SymmetryDisplacementPotential"

\end_inset

, we find
\begin_inset Formula 
\begin{eqnarray}
\Delta_{\kappa,j,\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}\bigl(g_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\bigr) & = & {\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\cdot g_{\kappa}\cdot\boldsymbol{u}_{\kappa,j\boldsymbol{0}}\\
\Delta_{\kappa,j,\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}\bigl(g_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\bigr) & = & {\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\cdot\boldsymbol{u}_{\kappa,j^{\prime}\boldsymbol{0}}
\end{eqnarray}

\end_inset

Since 
\begin_inset Formula $g_{\kappa}$
\end_inset

 is a site-symmetry, the atom index in the transformed 
\begin_inset Formula $\boldsymbol{u}_{\kappa,j^{\prime}\boldsymbol{0}}$
\end_inset

 does not change while we obtain an independent reducible displacement.
 Again, the system can be overdetermined which allows us to reduce statistical
 errors.
 We solve with all reducible 
\begin_inset Formula $j$
\end_inset

 displacement that can be obtained and find with
\begin_inset Formula 
\begin{equation}
\mathcal{V}_{\boldsymbol{R}}^{\kappa}(\boldsymbol{r})=\left(\begin{array}{ccc}
\{g_{\kappa}^{j=1}\vert0\}\; & \{g_{\kappa}^{j=2}\vert0\} & \ldots\end{array}\right)\Delta_{\kappa\boldsymbol{0}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}-\boldsymbol{R})
\end{equation}

\end_inset

and 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $U_{\alpha}$
\end_inset

 as above,
\begin_inset Formula 
\begin{equation}
\mathcal{V}_{\boldsymbol{R}}^{\kappa}(\boldsymbol{r})={\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}(\boldsymbol{r}-\boldsymbol{R})\cdot U_{\alpha}
\end{equation}

\end_inset

and the linear displacement potential in cartesian coordinates as a solution
 in the least squares sense
\begin_inset Formula 
\begin{equation}
{\boldsymbol{\delta v}_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\kappa}(\boldsymbol{r}-\boldsymbol{R})=\mathcal{V}_{\boldsymbol{R}}^{\kappa}(\boldsymbol{r})\cdot U_{\kappa}^{+}\label{eq:DisplacementPotentialLinear}
\end{equation}

\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit
Applying the same procedure regarding the definition of Fourier vectors
\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}\approx\begin{cases}
w_{\boldsymbol{R}}{\delta v_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\mu\alpha}(\boldsymbol{r}-\boldsymbol{R}) & \boldsymbol{R}\in\boldsymbol{M}\\
0 & {\rm else}
\end{cases}
\end{equation}

\end_inset

reducible atomic sites can be reconstructed from Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:SymmetryDisplacementPotential"

\end_inset

.
 To be explicit, again, we shift the reference frame for each
\begin_inset Formula $\boldsymbol{\tau}_{i}$
\end_inset

 in the unit cell to the center of the supercell.
 
\begin_inset Formula $\boldsymbol{M}$
\end_inset

 constitutes the set of 
\begin_inset Formula $\boldsymbol{R}$
\end_inset

 that extend within the supercell radius while in principle including all
 borders with appropriate weight factors.
 Since 
\begin_inset Formula $\boldsymbol{r}$
\end_inset

 is a dense grid, in practice we have neglected the weight factor because
 in any integral over real space, the fraction of the border is very small.
\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}[\{\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}\}](\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}\approx\begin{cases}
{\delta v_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\mu\alpha}(\boldsymbol{r}-\boldsymbol{R}) & \boldsymbol{R}\in\boldsymbol{M}\\
0 & {\rm else}
\end{cases}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Coupling to a phonon mode
\end_layout

\begin_layout Standard
In the following, we are concerned with the calculation of the displacement
 potential of a given phonon mode.
 As is shown in the literature, 
\begin_inset Formula 
\begin{equation}
\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}=\sum_{\boldsymbol{R}\kappa\alpha}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}
\end{equation}

\end_inset

where using 
\begin_inset Formula $C_{\boldsymbol{q}+\boldsymbol{G}\kappa\alpha,\nu}=C_{\boldsymbol{q}\kappa\alpha,\nu}$
\end_inset

, 
\begin_inset Formula $\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})/\delta u_{\boldsymbol{q}+\boldsymbol{G}\nu}=\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})/\delta u_{\boldsymbol{q}\nu}$
\end_inset

 for any 
\begin_inset Formula $\boldsymbol{G}$
\end_inset

.
 Moreover
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}+\boldsymbol{R}^{\prime})}{\delta u_{\boldsymbol{q}\nu}} & = & \sum_{\boldsymbol{R}\kappa\alpha}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}-\boldsymbol{R}^{\prime}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\\
 & = & {\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}^{\prime}}\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}
\end{eqnarray}

\end_inset

establishing the analogy to a Bloch wave.
 Thus it makes sense to introduce, by analogy to the Bloch wave, the lattice
 periodic part
\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}=\sum_{\boldsymbol{R}\kappa\alpha}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}-\boldsymbol{r})}\equiv\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}{\rm e}^{{\rm i}\boldsymbol{q}\cdot\boldsymbol{r}}
\end{equation}

\end_inset

for which
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}+\boldsymbol{R}^{\prime})}{\delta u_{\boldsymbol{q}\nu}} & = & \sum_{\boldsymbol{R}\kappa\alpha}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{R}-\boldsymbol{R}^{\prime}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot(\boldsymbol{R}-\boldsymbol{R}^{\prime}-\boldsymbol{r})}\\
 & = & \frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}
\end{eqnarray}

\end_inset

Note, however, that clearly 
\begin_inset Formula 
\begin{equation}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}+\boldsymbol{G}\nu}}=\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}{\rm e}^{{\rm i}\boldsymbol{G}\cdot\boldsymbol{r}}\label{eq:UmklappDVscf}
\end{equation}

\end_inset

This is an important fact to keep in mind when a symmetry takes 
\begin_inset Formula $\boldsymbol{q}$
\end_inset

 to 
\begin_inset Formula $g^{-1}\boldsymbol{q}+\boldsymbol{G}$
\end_inset

 for example if 
\begin_inset Formula $\boldsymbol{q}$
\end_inset

 is on the border of the cell.
 Let us futher apply a symmetry operation of the lattice and rotate real
 space, then
\begin_inset Formula 
\begin{eqnarray}
\{g|\tau\}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}} & = & \sum_{\boldsymbol{R}\kappa\alpha}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}\bigl(g^{-1}(\boldsymbol{r}-\boldsymbol{R})-\tau\bigr)}{\delta\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{0}}}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{R}}\\
 & = & \sum_{\boldsymbol{R}\kappa\alpha\alpha^{\prime}}\sqrt{\frac{{\rm u}}{m_{\kappa}}}C_{\boldsymbol{q}\kappa\alpha,\nu}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta\boldsymbol{\tau}_{\kappa^{\prime}\alpha^{\prime}\boldsymbol{R}}}g_{\alpha^{\prime}\alpha}^{-1}{\rm e}^{-{\rm i}(g^{-1}\boldsymbol{q})\cdot\boldsymbol{R}}
\end{eqnarray}

\end_inset

using [Symmetry properties of the normal vibration of a crystal] Eq.
 2.33, we have
\begin_inset Formula 
\begin{equation}
C_{g^{-1}\boldsymbol{q}\kappa^{\prime}\alpha^{\prime},\nu}=\sum_{\alpha}g_{\alpha^{\prime}\alpha}C_{\boldsymbol{q}\kappa\alpha,\nu}{\rm e}^{{\rm i}\boldsymbol{q}(\boldsymbol{\tau}_{\kappa^{\prime}\alpha^{\prime}\boldsymbol{0}}-\boldsymbol{\tau}_{\kappa\alpha\boldsymbol{0}})}
\end{equation}

\end_inset

which can be extended to form the matrix transformation.
\end_layout

\begin_layout Subsection
Matrix elements between Bloch orbitals
\end_layout

\begin_layout Standard
In a normalization convention adopted in many electronic structure codes
 
\begin_inset Formula 
\begin{equation}
\int_{{\rm UC}}{\rm d}\boldsymbol{r}\vert\psi_{\boldsymbol{k}i}(\boldsymbol{r})\vert^{2}=1
\end{equation}

\end_inset

Thus, if we insist on the total normalization of Bloch states, but still
 use the convention, we must use a different form of integral over the entire
 space
\begin_inset Formula 
\begin{equation}
\frac{1}{N_{\boldsymbol{q}}}\int{\rm d}\boldsymbol{r}\vert\psi_{\boldsymbol{k}i}(\boldsymbol{r})\vert^{2}=1
\end{equation}

\end_inset

Now, let us compute the overlap among Bloch states 
\begin_inset Formula $\psi_{\boldsymbol{k}i}(\boldsymbol{r})$
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{widetext}
\end_layout

\end_inset

 
\begin_inset Formula 
\begin{eqnarray}
g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{q}) & = & \frac{1}{N_{\boldsymbol{q}}}\int{\rm d}\boldsymbol{r}\psi_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}\psi_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r})\\
 & = & \frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{R}^{\prime}}\int_{{\rm UC}}{\rm d}\boldsymbol{r}\psi_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r}+\boldsymbol{R}^{\prime})\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}+\boldsymbol{R}^{\prime})}{\delta u_{\boldsymbol{q}\nu}}\psi_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r}+\boldsymbol{R}^{\prime})\\
 & = & \int_{{\rm UC}}{\rm d}\boldsymbol{r}u_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta V_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}u_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r}){\rm e}^{{\rm i}(\boldsymbol{k}^{\prime}-\boldsymbol{k})\cdot\boldsymbol{r}}\frac{1}{N_{\boldsymbol{q}}}\sum_{\boldsymbol{R}^{\prime}}{\rm e}^{{\rm i}(\boldsymbol{k}^{\prime}-\boldsymbol{k}-\boldsymbol{q})\cdot\boldsymbol{R}^{\prime}}\\
 & = & \int_{{\rm UC}}{\rm d}\boldsymbol{r}u_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}u_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r}){\rm e}^{{\rm i}(\boldsymbol{k}^{\prime}-\boldsymbol{k}-\boldsymbol{q})\cdot\boldsymbol{r}}\delta_{\boldsymbol{k}^{\prime}-\boldsymbol{k}-\boldsymbol{q},\boldsymbol{G}_{0}}\\
 & = & \delta_{\boldsymbol{q},\boldsymbol{k}^{\prime}-\boldsymbol{k}+\boldsymbol{G}_{0}}\int_{{\rm UC}}{\rm d}\boldsymbol{r}u_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}+\boldsymbol{G}_{0}\nu}}u_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r}){\rm e}^{{\rm i}\boldsymbol{G}_{0}\cdot\boldsymbol{r}}\label{eq:BlochElphCoupling}
\end{eqnarray}

\end_inset

Here, we have used 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:UmklappDVscf"

\end_inset

 to introduce the reciprocal lattice vector 
\begin_inset Formula $\boldsymbol{G}_{0}$
\end_inset

 which maps
\begin_inset Formula 
\begin{equation}
\boldsymbol{k}-\boldsymbol{k}^{\prime}+\boldsymbol{G}_{0}\in1.{\rm BZ}
\end{equation}

\end_inset

 Moreover, because of Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SymmetryDisplacementPotential"

\end_inset

, we have (where we use that 
\begin_inset Formula $m_{\mu}$
\end_inset

 is the same for all symmetry related atoms, and thus does not need to be
 transformed)
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}} & = & \sum_{\boldsymbol{M}\mu}\sqrt{\frac{{\rm u}}{m_{\mu}}}C_{\boldsymbol{q}\nu\mu}\{g^{-1}\cdot\nabla_{i_{\mu}\boldsymbol{0}}\boldsymbol{v}_{{\rm {\scriptscriptstyle scf}}}[g^{-1}(\boldsymbol{r}-\boldsymbol{M})-\tau]\}{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{M}}\\
\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}} & = & \sum_{\boldsymbol{M}\mu}\sqrt{\frac{{\rm u}}{m_{\mu}}}C_{\boldsymbol{q}\nu\mu}\{g^{-1}\cdot\nabla_{i_{\mu}\boldsymbol{0}}\boldsymbol{v}_{{\rm {\scriptscriptstyle scf}}}[g^{-1}\boldsymbol{r}-\tau-\boldsymbol{M}]\}{\rm e}^{-{\rm i}(g^{-1}\cdot\boldsymbol{q})\cdot\boldsymbol{M}}
\end{eqnarray}

\end_inset

and thus
\begin_inset Formula 
\begin{equation}
g\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(g\boldsymbol{r}+\tau)}{\delta u_{g\boldsymbol{q}\nu}}=\sum_{\boldsymbol{M}\mu}\sqrt{\frac{{\rm u}}{m_{\mu}}}(g\cdot C_{g\boldsymbol{q}}\cdot g^{-1})_{\nu\mu}[\nabla_{i_{\mu}\boldsymbol{0}}\boldsymbol{v}_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}-\boldsymbol{M})]{\rm e}^{-{\rm i}\boldsymbol{q}\cdot\boldsymbol{M}}
\end{equation}

\end_inset

In a numerical evaluation 
\begin_inset Formula $\int_{{\rm UC}}{\rm d}\boldsymbol{r}\ldots\approx\sum_{j}\frac{{\rm \Omega_{{\rm UC}}}}{N_{j}}\ldots$
\end_inset

 and so 
\begin_inset Formula 
\begin{equation}
g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{q})\approx\sum_{j}\frac{{\rm \Omega_{{\rm UC}}}}{N_{j}}\tilde{u}_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r}_{j})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}_{j})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}\tilde{u}_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r}_{j})
\end{equation}

\end_inset

Note that the normalization of the wavefunctions in the code is chosen as
 
\begin_inset Formula 
\begin{equation}
\sum_{j}\vert u_{\boldsymbol{k}i}(\boldsymbol{r}_{j})\vert^{2}=1
\end{equation}

\end_inset

and thus already includes the volume factor 
\begin_inset Formula ${\rm \Omega_{{\rm UC}}}/N_{j}$
\end_inset

.
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{widetext}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In practice, we will compute 
\begin_inset Formula $\psi_{\boldsymbol{k}i}(\boldsymbol{r})$
\end_inset

 on a dense 
\begin_inset Formula $\boldsymbol{k}$
\end_inset

 mesh.
 Then, we generate a list of 
\begin_inset Formula $\{\boldsymbol{k}_{{\rm F}}^{i}\}$
\end_inset

 vectors to triangulate the Fermi surface of band 
\begin_inset Formula $i$
\end_inset

 together with the 
\begin_inset Formula $\boldsymbol{k}$
\end_inset

 point weight 
\begin_inset Formula $w_{\boldsymbol{k}}^{i}$
\end_inset

.
 Now, we compute a list of all 
\begin_inset Formula $\{\boldsymbol{q}^{i,i^{\prime}}|\boldsymbol{q}=\boldsymbol{k}-\boldsymbol{k}^{\prime};\boldsymbol{k}\in\{\boldsymbol{k}_{{\rm F}}^{i}\},\boldsymbol{k}^{\prime}\in\{\boldsymbol{k}_{{\rm F}}^{i^{\prime}}\}\}$
\end_inset

 vectors as the set 
\begin_inset Formula $\boldsymbol{k}_{{\rm F}}^{i}-\boldsymbol{k}_{{\rm F}}^{j}$
\end_inset

 for all 
\begin_inset Formula $i$
\end_inset

 and 
\begin_inset Formula $j$
\end_inset

 that enumarte the vectors on the Fermi surface.
 The wavefunctions will be approximated by what is the closest regular grid
 vector to the Fermi surface 
\begin_inset Formula $\boldsymbol{k}_{{\rm F}}^{i}$
\end_inset

.
 Now, for each 
\begin_inset Formula $\boldsymbol{k}\in\{\boldsymbol{k}_{{\rm F}}\}$
\end_inset

 we go though all 
\begin_inset Formula $\boldsymbol{k}^{\prime}\in\{\boldsymbol{k}_{{\rm F}}\}$
\end_inset

, compute the matrix of force constants in reciprocal via Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:MatrixForceConstantsInterpol"

\end_inset

 and obtain 
\begin_inset Formula $\tilde{C}({\rm grid}(\boldsymbol{k}-\boldsymbol{k}^{\prime})\mu_{1},\mu_{2})/\sqrt{m_{\mu_{1}}m_{\mu_{2}}}$
\end_inset

, diagonalize it to find the dynamical matrix via
\begin_inset Formula 
\begin{equation}
\frac{\tilde{C}(\boldsymbol{q}\mu_{1},\mu_{2})}{\sqrt{m_{\mu_{1}}m_{\mu_{2}}}}=\sum_{\nu}C_{\boldsymbol{q}\mu_{1}\nu}\varOmega_{\boldsymbol{q}\nu}^{2}C_{\boldsymbol{q}\nu\mu_{2}}^{\dagger}
\end{equation}

\end_inset

and find, first 
\begin_inset Formula $\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})/\delta u_{\boldsymbol{q}\nu}$
\end_inset

 and second the overlap integral Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BlochElphCoupling"

\end_inset

.
 The Eliashberg function is defined by
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{widetext}
\end_layout

\end_inset


\begin_inset Formula 
\begin{equation}
\alpha^{2}\,F(\omega)=\frac{1}{\rho(E_{{\rm F}})}\sum_{ii^{\prime}\nu}\int{\rm d}\boldsymbol{k}\int{\rm d}\boldsymbol{k}^{\prime}\frac{\vert g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{k}^{\prime}-\boldsymbol{k})\vert^{2}}{2\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}\delta(\varepsilon_{\boldsymbol{k}i}-E_{{\rm F}})\delta(\varepsilon_{\boldsymbol{k}^{\prime}i^{\prime}}-E_{{\rm F}})\delta(\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}-\omega)
\end{equation}

\end_inset


\begin_inset Formula $\rho(E_{{\rm F}})$
\end_inset

 is the density of states at the Fermi level.
 The evaluation of the delta functions is a numericaly difficult.
 The approach we persue here is to triangulate the Fermi surface.
 Using the propery of the Dirac delta distribution [Wikipeida]
\begin_inset Formula 
\begin{equation}
\int{\rm d}\boldsymbol{k}\delta(\varepsilon_{\boldsymbol{k}i}-E_{{\rm F}})f(\boldsymbol{k})=\int_{\varepsilon_{\boldsymbol{k}_{f}i}=E_{{\rm F}}}{\rm d}\boldsymbol{k}_{f}\frac{f(\boldsymbol{k}_{f})}{\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert}
\end{equation}

\end_inset

which transform the 
\begin_inset Formula $3D$
\end_inset

 Brillouin zone intergral into an integral over the Fermi surface we can
 circumvent problems other methods face.
 For example a metropolis algorithm has problems with the reporducibility
 and poor convergence of grids.
 With our triangulations, the surface integral is readily computed as
\begin_inset Formula 
\begin{eqnarray}
\alpha^{2}\,F(\omega) & = & \frac{1}{\rho(E_{{\rm F}})}\sum_{ii^{\prime}\nu}\int_{{\rm FS}}{\rm d}\boldsymbol{k}_{f}\int_{{\rm FS}}{\rm d}\boldsymbol{k}_{f}^{\prime}\frac{\vert g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{k}^{\prime}-\boldsymbol{k})\vert^{2}}{\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert\vert\nabla\varepsilon_{\boldsymbol{k}_{f}^{\prime}i^{\prime}}\vert}\delta(\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}-\omega)\label{eq:AlphaSquaredF}\\
 & \approx & \frac{1}{\rho(E_{{\rm F}})}\sum_{ii^{\prime}\nu}\sum_{\boldsymbol{k}_{f}}\sum_{\boldsymbol{k}_{f}^{\prime}}\frac{\vert g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{k}^{\prime}-\boldsymbol{k})\vert^{2}}{\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert\vert\nabla\varepsilon_{\boldsymbol{k}_{f}^{\prime}i^{\prime}}\vert}\delta(\varOmega_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}-\omega)w_{\boldsymbol{k}_{f}}w_{\boldsymbol{k}_{f}^{\prime}}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $w_{\boldsymbol{k}_{f}}$
\end_inset

 is the Fermi surface area associated to a given Fermi vector.
 Combining 
\begin_inset Formula 
\begin{equation}
\frac{{\rm d}\boldsymbol{k}_{f}}{\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert}\approx\tilde{w}_{\boldsymbol{k}_{f}}
\end{equation}

\end_inset

we can use the tetrahedra method of computing the DOS
\begin_inset Formula 
\begin{eqnarray}
\rho(E_{f}) & = & \sum_{i}\int{\rm d}\boldsymbol{k}\delta(\varepsilon_{\boldsymbol{k}i}-E_{{\rm F}})\\
 &  & \equiv\sum_{i}\int_{\varepsilon_{\boldsymbol{k}i}=E_{f}}\frac{{\rm d}^{2}\boldsymbol{k}_{f}}{\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert}\\
 & \approx & \sum_{il}\tilde{w}_{l}^{i}\equiv\sum_{im}t_{m}^{i}
\end{eqnarray}

\end_inset

where, thus, 
\begin_inset Formula $\tilde{w}_{l}^{i}$
\end_inset

 are the combination of area weight and inverse Fermi velocitiy at the Fermi
 surface point 
\begin_inset Formula $\boldsymbol{k}_{li}$
\end_inset

.
 The tetrahedra method for computing the DOS adds up the contribution of
 each individual tetrahedron 
\begin_inset Formula $t_{m}^{i}$
\end_inset

.
 In an additional step, we here compute the isosurface.
 Each tetrahedron that intersects the Fermi surface has 3-4 Fermi corner
 points that may conincide.
 The strategy adopted here is to compute the contribution of each tetrahedron
 to the DOS and distribute it evenly to the 3-4 Fermi points it creates.
 This allows us to find an efficient approximation
\begin_inset Formula 
\begin{equation}
\alpha^{2}\,F(\omega)\approx\frac{1}{\rho(E_{{\rm F}})}\sum_{ii^{\prime}ll^{\prime}\nu}\frac{\vert g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})\vert^{2}}{\varOmega_{\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li}\nu}}\delta(\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}-\omega)\tilde{w}_{l}^{i}\tilde{w}_{l^{\prime}}^{i^{\prime}}
\end{equation}

\end_inset

The one remaining delta function is evaluated using a simple approximation
\begin_inset Formula 
\begin{equation}
\delta(\omega)\approx\frac{1}{\omega_{0}}\Theta(\frac{\omega_{0}}{2}-\vert\omega\vert)
\end{equation}

\end_inset

where the step width in the grid 
\begin_inset Formula $\omega_{0}$
\end_inset

 needs to be much larger than the number of sampling points in Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:AlphaSquaredF"

\end_inset

.
\end_layout

\begin_layout Subsection
Symmetry properties of the electron-phonon matrix element
\end_layout

\begin_layout Standard

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Here we investigate the transformation properties of 
\begin_inset Formula 
\begin{equation}
g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{k}^{\prime}-\boldsymbol{k})=\iint_{{\rm UC}}{\rm d}\boldsymbol{r}\psi_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}\psi_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r})
\end{equation}

\end_inset

transforming space acts on
\begin_inset Formula 
\begin{equation}
\{g|\tau\}\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}=
\end{equation}

\end_inset


\begin_inset Formula 
\begin{eqnarray}
g_{T\boldsymbol{k},T\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(T\boldsymbol{k}^{\prime}-T\boldsymbol{k}) & = & \iint_{{\rm UC}}{\rm d}\boldsymbol{r}\psi_{T\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{T(\boldsymbol{k}^{\prime}-\boldsymbol{k})g(\nu)}}\psi_{T\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r})\\
 & = & \iint_{{\rm UC}}{\rm d}\boldsymbol{r}\psi_{\boldsymbol{k}i}^{\ast}(T^{-1}\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(T^{-1}\boldsymbol{r})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}\psi_{\boldsymbol{k}^{\prime}i^{\prime}}(T^{-1}\boldsymbol{r})\\
 & = & \iint_{{\rm UC}}{\rm d}T^{-1}\boldsymbol{r}\psi_{\boldsymbol{k}i}^{\ast}(\boldsymbol{r})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{k}^{\prime}-\boldsymbol{k}\nu}}\psi_{\boldsymbol{k}^{\prime}i^{\prime}}(\boldsymbol{r})=g_{\boldsymbol{k},\boldsymbol{k}^{\prime}}^{i,i^{\prime}\nu}(\boldsymbol{k}^{\prime}-\boldsymbol{k})
\end{eqnarray}

\end_inset

thus, we can write
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit

\begin_inset Formula 
\begin{eqnarray}
\alpha^{2}\,F(\omega) & = & \frac{1}{2\omega\rho(E_{{\rm F}})}\sum_{l\in{\rm Irred}}\sum_{S_{l}}\sum_{ii^{\prime}l^{\prime}\nu}\vert g_{S_{l}\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-S_{l}\boldsymbol{k}_{li})\vert^{2}\delta(\varOmega_{S_{l}\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}-\omega)\tilde{w}_{l}^{i}\tilde{w}_{l^{\prime}}^{i^{\prime}}\\
 & = & \frac{1}{2\omega\rho(E_{{\rm F}})}\sum_{l\in{\rm Irred}}\sum_{S_{l}}\sum_{ii^{\prime}l^{\prime}\nu}\vert g_{S_{l}\boldsymbol{k}_{li},S_{l}\tilde{\boldsymbol{k}}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(S_{l}\tilde{\boldsymbol{k}}_{i^{\prime}l^{\prime}}-S_{l}\boldsymbol{k}_{li})\vert^{2}\delta(\varOmega_{S_{l}\boldsymbol{k}_{li}-S_{l}\tilde{\boldsymbol{k}}_{i^{\prime}l^{\prime}}\nu}-\omega)\tilde{w}_{l}^{i}\tilde{w}_{l^{\prime}}^{i^{\prime}}\\
 & = & \frac{1}{\rho(E_{{\rm F}})}\sum_{l\in{\rm Irred}}\sum_{ii^{\prime}l^{\prime}\nu}\frac{\vert g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})\vert^{2}}{2\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}}\delta(\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}-\omega)\tilde{w}_{l}^{i}\tilde{w}_{l^{\prime}}^{i^{\prime}}\sum_{S_{l}}1\label{eq:a2FSymmetricTetra}
\end{eqnarray}

\end_inset

where we have rearranged the sum over 
\begin_inset Formula $l^{\prime}$
\end_inset

 such that 
\begin_inset Formula $\tilde{\boldsymbol{k}}_{i^{\prime}l^{\prime}}=S_{l}^{-1}\boldsymbol{k}_{i^{\prime}l^{\prime}}\rightarrow\boldsymbol{k}_{i^{\prime}l^{\prime}}$
\end_inset

 which is possible since the full star is present and thus 
\begin_inset Formula $S_{l}^{-1}\boldsymbol{k}_{i^{\prime}l^{\prime}}$
\end_inset

 is only reshuffeling vectors.
 We have also used that 
\begin_inset Formula $\varOmega_{\boldsymbol{q}\nu}$
\end_inset

 and the weights are grid symmetric.
\end_layout

\begin_layout Section
(More) Technical aspects
\end_layout

\begin_layout Subsection
The displacement potential in a PAW setting
\end_layout

\begin_layout Standard
Let us have a look at the order of numerical complexity in determining
\begin_inset Formula 
\begin{equation}
{\delta v_{{\rm {\scriptscriptstyle scf}}}^{\Sigma}}_{\mu\alpha}(\boldsymbol{r}-\boldsymbol{R})
\end{equation}

\end_inset

for 
\begin_inset Formula $\boldsymbol{R}\in\boldsymbol{M}$
\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Formula $\mathcal{O}(\boldsymbol{M})\sim100$
\end_inset

 since the interactions are usually pretty local and screening is good.
 If not, every method has problems, DFPT argumbly less than finite displacement,
 though.
 
\end_layout

\begin_layout Standard
There are easily 
\begin_inset Formula $\mathcal{O}(\boldsymbol{r})\sim10^{5}$
\end_inset

 since we need to resolve the atomic potential accurately and the Fourier
 grid is usually very fine.
 Furthermore, we have 
\begin_inset Formula $3\times N_{{\rm atoms}}$
\end_inset

 modes in the system where 
\begin_inset Formula $N_{{\rm atoms}}$
\end_inset

 is the number of atoms in the primitive cell.
 Assuming 
\begin_inset Formula $\mathcal{O}(10^{2})$
\end_inset

 modes, we have to store 
\begin_inset Formula $10^{8}$
\end_inset

 real (single pricision) values, which is 
\begin_inset Formula $\mathcal{O}(10)$
\end_inset

GB of data and easily managable of modern computer hardware.
 This estimation is for a rather large system.
\end_layout

\begin_layout Standard
[TODO/ Dec 8: ] Consulting with G.
 Kresse, we have to include the atomic site contributions because LOCPOT
 is only the plane-wave part, not the AE part fittet to the plane wave mesh.
\end_layout

\begin_layout Standard
In the derivation, we have used the all electron Kohn-Sham potential.
 The full AE potential is given by the Hartree plus exchange correlation
 potential 
\begin_inset Formula 
\begin{equation}
v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})=v_{{\rm {\scriptscriptstyle H}}}[n+n_{Z}](\boldsymbol{r})+v_{{\rm {\scriptscriptstyle xc}}}[n](\boldsymbol{r})
\end{equation}

\end_inset

Here, here, 
\begin_inset Formula $n$
\end_inset

 is the full electronic charge density and 
\begin_inset Formula $n_{Z}$
\end_inset

 is point charge density of the cores.
 In its standard implementation, VASP uses the frozen core approximation.
 That means it uses the following quantities
\begin_inset Formula 
\begin{eqnarray}
\tilde{n} & : & \text{regular grid valence pseudo charge}\\
n^{1} & : & \text{radial grid valence AE charge}\\
\tilde{n}^{1} & : & \text{radial grid valence pseudo charge}\\
n_{c} & : & \text{radial grid frozen core charge density}\\
\tilde{n}_{c} & : & \text{radial grid frozen core partial charge density}\nonumber \\
 &  & \tilde{n}_{c}=n_{c}\;{\rm for}\;r>r_{pc}\\
n_{Zc} & : & n_{Z}+n_{c}\\
\hat{n} & : & \text{smooth compensation charge density}
\end{eqnarray}

\end_inset

The calcaution are done on two seperate grids, a regular plane wave grid
 and a radial support grid around each atom.
 In order to seperate terms in the Hartree potential, 
\begin_inset Formula $\tilde{n}$
\end_inset

 and 
\begin_inset Formula $\tilde{n}^{1}$
\end_inset

 are treated as equaivalent, which is only exact for a complete set of projector
 functions.
 [Kresse and Joubert, P.
 Bloechel].
 Fortunately, the AE potential can be reconstructed in the PAW method via
 the equation [P.
 Bloechel Eq.
 41]
\begin_inset Formula 
\begin{equation}
v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})=\tilde{v}_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})+v_{{\rm {\scriptscriptstyle scf}}}^{1}(\boldsymbol{r})-\tilde{v}_{{\rm {\scriptscriptstyle scf}}}^{1}(\boldsymbol{r})
\end{equation}

\end_inset

The 
\begin_inset Formula $\tilde{v}_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

 is the pseudo potential on the regular Fourier grid, 
\begin_inset Formula $v_{{\rm {\scriptscriptstyle scf}}}^{1}(\boldsymbol{r})$
\end_inset

 is the AE one center contribution and 
\begin_inset Formula $\tilde{v}_{{\rm {\scriptscriptstyle scf}}}^{1}(\boldsymbol{r})$
\end_inset

 is the one center pseudo potential contribution both stored on a radial
 grid around an atomic sphere.
 The effective Hamiltonian, VASP solves is
\begin_inset Formula 
\begin{equation}
\hat{H}_{{\rm VASP}}=-\frac{\hbar^{2}}{2m_{e}}\boldsymbol{\nabla}^{2}+\tilde{v}_{{\rm eff}}(\boldsymbol{r})+\sum_{(i,j)}\vert\tilde{p}_{i}\rangle(\hat{D}_{ij}+D_{ij}^{1}-\tilde{D}_{ij}^{1})\langle\tilde{p}_{j}\vert
\end{equation}

\end_inset

with
\begin_inset Formula 
\begin{equation}
\tilde{v}_{{\rm eff}}(\boldsymbol{r})=\tilde{v}_{{\rm H}}[\tilde{n}+\hat{n}+\tilde{n}_{Zc}](\boldsymbol{r})+\tilde{v}_{{\rm xc}}[\tilde{n}+\hat{n}+\tilde{n}_{c}](\boldsymbol{r})
\end{equation}

\end_inset

while we, on the other hand, are interested in the AE potential.
 First, if we are in the interstitial region, 
\begin_inset Formula $\tilde{v}_{{\rm eff}}(\boldsymbol{r})$
\end_inset

 is the correct AE Kohn-Sham potential.
 This is not immediately obvious, since we have added the smooth compensation
 charge density, but the compensation charge density is constructed to reproduce
 the AE multipole moments of the charge distribution localized in the core.
 The non-local parts of the Hamiltonian are mostly irrelevant for our purposes,
 since we work with the AE reconstructed quantities, except that 
\begin_inset Formula $D_{ij}^{1}$
\end_inset

 contains the AE potential in the atomic radial grid.
 At the same time 
\begin_inset Formula $\tilde{D}_{ij}^{1}$
\end_inset

 removes the local pseudo potential 
\begin_inset Formula $\tilde{v}_{{\rm eff}}(\boldsymbol{r})$
\end_inset

 and the effect of the compensation charge in the augumentation region (for
 a complete set of partial waves).
\end_layout

\begin_layout Standard
In VASP quantities on the radial grid, such as the AE potential, are handled
 as expansion coefficients of real spherical harmonics.
 In order to handle the data in elephon, we have to 1) be able to integrate
 potential and wavefunction on the radial plus regular grid 2) apply symmetry
 operations also on the radial support grid.
 The rotation on the radial support grid is described by a Wigner matrix,
 that transforms the spherical harmonics and thereby the coefficients.
\end_layout

\begin_layout Standard
The first point is not trivial, since it involves a regular plus spherical
 grid that intersect, making the integration weights on the grid difficult
 to determine.
 The integration on the regular grid is performed as
\begin_inset Formula 
\begin{equation}
\int_{{\rm UC}}{\rm d}\boldsymbol{r}f(\boldsymbol{r})\approx\frac{V}{N_{{\rm FFT}}}\sum_{i=0}^{N_{{\rm FFT}}-1}f(\boldsymbol{r}_{i})
\end{equation}

\end_inset

thus within each grid cube, where by convention 
\begin_inset Formula $\boldsymbol{r}_{i}$
\end_inset

 is the lower left bottom, the function is approximated as constant.
 We can thus combine different grids by
\begin_inset Formula 
\begin{equation}
\int_{{\rm UC}}{\rm d}\boldsymbol{r}f(\boldsymbol{r})\approx\sum_{i=0}^{N_{{\rm FFT}}-1}\frac{V}{N_{{\rm FFT}}}f(\boldsymbol{r}_{i})+\sum_{j}w_{j}\{f(\boldsymbol{r}_{j})-f[M_{{\rm FFT}}(\boldsymbol{r}_{j})]\}
\end{equation}

\end_inset

where 
\begin_inset Formula $M_{{\rm FFT}}(\boldsymbol{r}_{j})$
\end_inset

 selects the grid cube 
\begin_inset Formula $\boldsymbol{r}_{j}$
\end_inset

 is in and returns the lower left bottom 
\begin_inset Formula $\boldsymbol{r}_{i}$
\end_inset

 of that grid cube.
 
\begin_inset Formula $w_{j}$
\end_inset

 are the weights of the arbitray additional intersecting grid.
 Since the coarse sampling of the regular mesh may actually describe a different
 function 
\begin_inset Formula $\tilde{f}$
\end_inset

 within the region where the additional grid is as in the PAW method, we
 can write
\begin_inset Formula 
\begin{equation}
\int_{{\rm UC}}{\rm d}\boldsymbol{r}f(\boldsymbol{r})\approx\sum_{i=0}^{N_{{\rm FFT}}-1}\frac{V}{N_{{\rm FFT}}}\tilde{f}(\boldsymbol{r}_{i})+\sum_{j}w_{j}\{f(\boldsymbol{r}_{j})-\tilde{f}[M_{{\rm FFT}}(\boldsymbol{r}_{j})]\}
\end{equation}

\end_inset

since the integral does depend on 
\begin_inset Formula $\tilde{f}$
\end_inset

 given that 
\begin_inset Formula $\tilde{f}=f$
\end_inset

 outside of the additional grid region.
 Since 
\begin_inset Formula $f$
\end_inset

 is supposed to be continous within the PAW method, this means we can cross
 check that 
\begin_inset Formula $\sum_{j\in{\rm Border}}w_{j}\{f(\boldsymbol{r}_{j})-\tilde{f}[M_{{\rm FFT}}(\boldsymbol{r}_{j})]\}\approx0$
\end_inset

 because of the constrained 
\begin_inset Formula $\tilde{f}=f$
\end_inset

.
 Furthermore, it will be impossible to compute derivates w.r.t.
 the atomic position for extremely sharp contributions to the total AE potential
 originating from the core delta peak charge using finite displacements.
 Thus we single out these contribution (
\begin_inset Formula $\boldsymbol{v}_{\kappa\boldsymbol{R}}=(\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}-\boldsymbol{\tau}_{\kappa\boldsymbol{R}})/\vert\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}-\boldsymbol{\tau}_{\kappa\boldsymbol{R}}\vert$
\end_inset

)
\begin_inset Formula 
\begin{eqnarray}
V^{{\rm frozen}}[\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\}](\boldsymbol{r}) & = & \sum_{\kappa\boldsymbol{R}}\frac{Z_{\kappa}}{\vert\boldsymbol{r}-\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\vert}\\
\frac{\delta V^{{\rm frozen}}}{\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}}\biggr\vert_{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}}(\boldsymbol{r}) & = & Z_{\kappa}\boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\frac{\boldsymbol{r}-\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}}{\vert\boldsymbol{r}-\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}\vert^{3}}
\end{eqnarray}

\end_inset

On a radial grid with 
\begin_inset Formula $\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}=0$
\end_inset

, we have thus
\begin_inset Formula 
\begin{equation}
\frac{\delta V^{{\rm frozen}}}{\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}}\biggr\vert_{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}^{0}}(\boldsymbol{r})=\frac{Z_{\kappa}}{\vert\boldsymbol{r}\vert^{2}}{\rm cos}[\angle(\boldsymbol{v}_{\kappa\boldsymbol{R}},\boldsymbol{r})]
\end{equation}

\end_inset

Note that 
\begin_inset Formula $\delta V^{{\rm frozen}}[\{\boldsymbol{\tau}_{\kappa\boldsymbol{R}}\}](\boldsymbol{r})/\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}$
\end_inset

 must only be applied to the core region, since it is implicitely already
 contained in the screened potential of the interstitial region.
 The frozen core Hartree contribution is zero, since the electronic density
 is not displaced with the nuclear position.
 However, since we assume that self-consistent screening is provied, we
 may alternatively assume, that the frozen Hartree follows the core peak
 instantaniously, this means 
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta}{\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}}\int{\rm d}\boldsymbol{r}^{\prime}\frac{n_{c}(\boldsymbol{r}^{\prime})}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert} & = & \lim_{\Delta\rightarrow0}\int{\rm d}\boldsymbol{r}^{\prime}[\frac{n_{c}(\boldsymbol{r}^{\prime}+\boldsymbol{v}_{\kappa\boldsymbol{R}}\Delta)}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert}-\frac{n_{c}(\boldsymbol{r}^{\prime})}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert}]\\
 & = & \lim_{\Delta\rightarrow0}\int{\rm d}\boldsymbol{r}^{\prime}[\frac{n_{c}(\boldsymbol{r}^{\prime})}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}+\boldsymbol{v}_{\kappa\boldsymbol{R}}\Delta)\vert}-\frac{n_{c}(\boldsymbol{r}^{\prime})}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert}]\\
 & = & \boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\boldsymbol{\nabla}_{\boldsymbol{r}}\int{\rm d}\boldsymbol{r}^{\prime}\frac{n_{c}(\boldsymbol{r}^{\prime})}{\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert}
\end{eqnarray}

\end_inset

using the Laplace expansion
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta}{\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}}\int{\rm d}\boldsymbol{r}^{\prime}\frac{n_{c}(\boldsymbol{r}^{\prime})}{4\pi\varepsilon\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert} & = & \frac{1}{\varepsilon}\boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\boldsymbol{\nabla}_{\boldsymbol{r}}\sum_{l=0}^{\infty}\int{\rm d}\vert\boldsymbol{r}^{\prime}\vert^{2}\bigl(\frac{{r^{\prime}}^{l}}{r^{l+1}}\uptheta(r-r^{\prime})+\frac{r^{l}}{{r^{\prime}}^{l+1}}\uptheta(r^{\prime}-r)\bigr)\times\nonumber \\
 &  & \times\int_{0}^{\pi}{\rm d}\theta^{\prime}\int_{0}^{2\pi}{\rm d}\phi^{\prime}{\rm sin}(\theta^{\prime})\sum_{m=-l}^{l}\frac{Y_{lm}(\theta,\phi)Y_{lm}^{\ast}(\theta^{\prime},\phi^{\prime})}{\sqrt{2l+1}}n_{c}(r^{\prime},\theta^{\prime},\phi^{\prime})
\end{eqnarray}

\end_inset

since the frozen core charge is spherical and the integral over the angle
 of
\begin_inset Formula 
\begin{eqnarray}
 &  & \int_{0}^{\pi}{\rm d}\theta\int_{0}^{2\pi}{\rm d}\phi{\rm sin}(\theta)Y_{lm}(\theta,\phi)\\
 & = & 2\sqrt{\pi}\int_{0}^{\pi}{\rm d}\theta\int_{0}^{2\pi}{\rm d}\phi{\rm sin}(\theta)Y_{lm}(\theta,\phi)Y_{00}^{\ast}(\theta,\phi)\\
 & = & 2\sqrt{\pi}\delta_{l,0}\delta_{m,0}
\end{eqnarray}

\end_inset

we find
\begin_inset Formula 
\begin{eqnarray}
\frac{\delta}{\delta\boldsymbol{\tau}_{\kappa\boldsymbol{R}}}\int{\rm d}\boldsymbol{r}^{\prime}\frac{n_{c}(\boldsymbol{r}^{\prime})}{4\pi\varepsilon\vert\boldsymbol{r}-\boldsymbol{r}^{\prime}\vert} & = & \frac{1}{\varepsilon}\boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\boldsymbol{\nabla}_{\boldsymbol{r}}\bigl(\int_{0}^{r}\frac{1}{r}+\int_{r}^{\infty}\frac{1}{r^{\prime}}\bigr)n_{c}(r^{\prime}){r^{\prime}}^{2}{\rm d}r^{\prime}\\
 & = & \frac{1}{\varepsilon}\boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\boldsymbol{\nabla}_{\boldsymbol{r}}\int_{0}^{\infty}\bigl(\frac{{r^{\prime}}^{2}}{r}\theta(r-r^{\prime})+r^{\prime}\theta(r^{\prime}-r)\bigr)n_{c}(r^{\prime}){\rm d}r^{\prime}\\
 & = & \frac{1}{\varepsilon}\boldsymbol{v}_{\kappa\boldsymbol{R}}\cdot\bigl(-\frac{\boldsymbol{r}}{r^{3}}\int_{0}^{r}{r^{\prime}}^{2}n_{c}(r^{\prime}){\rm d}r^{\prime}+rn_{c}(r)-rn_{c}(r)\bigr)\\
 & = & -\frac{1}{\varepsilon}\frac{{\rm cos}[\angle(\boldsymbol{v}_{\kappa\boldsymbol{R}},\boldsymbol{r})]}{r^{2}}\int_{0}^{r}{r^{\prime}}^{2}n_{c}(r^{\prime}){\rm d}r^{\prime}
\end{eqnarray}

\end_inset

such that the amount of core electronic charge density in a sphere smaller
 than the current position of an electron screens the core displacement.
 This makes sense.
\end_layout

\begin_layout Standard
In the following, we want to represent the displacement potential on the
 radial grid using spherical harmonics.
 This is easy, since the spherical harmonic
\begin_inset Formula 
\begin{equation}
Y_{10}(\theta,\phi)=\sqrt{\frac{3}{4\pi}}{\rm cos}(\theta)
\end{equation}

\end_inset

can already be used to represent the cosine.
 However, we need to align the displacement direction 
\begin_inset Formula $\boldsymbol{v}_{\kappa\boldsymbol{R}}$
\end_inset

 with the coordinate system so that in general these contributions will
 be some linear combination in the space of 
\begin_inset Formula $l=1$
\end_inset

.
\end_layout

\begin_layout Subsubsection
Transformation of real spherical harmonics
\end_layout

\begin_layout Standard
The potential is described in VASP in terms of real spherical harmonics
\begin_inset Formula 
\begin{equation}
\tilde{Y}_{l}^{m}(\theta,\phi)=\begin{cases}
\frac{{\rm i}}{\sqrt{2}}[Y_{l}^{m}(\theta,\phi)-(-1)^{m}Y_{l}^{-m}(\theta,\phi)] & m<0\\
Y_{l}^{m}(\theta,\phi) & m=0\\
\frac{1}{\sqrt{2}}[Y_{l}^{-m}(\theta,\phi)+(-1)^{m}Y_{l}^{m}(\theta,\phi)] & m>0
\end{cases}
\end{equation}

\end_inset

as the series
\begin_inset Formula 
\begin{equation}
v_{{\rm scf}}^{{\rm AE}-1}(\boldsymbol{r})=\sum_{lm}\tilde{Y}_{l}^{m}(\boldsymbol{r}/\vert\boldsymbol{r}\vert)v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)
\end{equation}

\end_inset

which can be written again in terms of the complex spherical harmonics as
\begin_inset Formula 
\begin{eqnarray}
v_{{\rm scf}}^{{\rm AE}-1}(\boldsymbol{r}) & = & \sum_{l,m<0}\frac{{\rm i}}{\sqrt{2}}[Y_{l}^{m}(\theta,\phi)-(-1)^{m}Y_{l}^{-m}(\theta,\phi)]v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)\nonumber \\
 &  & +\sum_{l}Y_{l}^{0}(\theta,\phi)v_{l}^{0}(\boldsymbol{\vert\boldsymbol{r}}\vert)+\sum_{l,m>0}\frac{1}{\sqrt{2}}[Y_{l}^{-m}(\theta,\phi)+(-1)^{m}Y_{l}^{m}(\theta,\phi)]v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)\\
 & = & \sum_{l}Y_{l}^{0}(\theta,\phi)v_{l}^{0}(\boldsymbol{\vert\boldsymbol{r}}\vert)+\sum_{l,m>0}\frac{1}{\sqrt{2}}[Y_{l}^{-m}(\theta,\phi){\rm i}v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)-(-1)^{-m}Y_{l}^{m}(\theta,\phi){\rm i}v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)\nonumber \\
 &  & +Y_{l}^{-m}(\theta,\phi)v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)+(-1)^{m}Y_{l}^{m}(\theta,\phi)v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)]\\
 & = & \sum_{l}Y_{l}^{0}(\theta,\phi)v_{l}^{0}(\boldsymbol{\vert\boldsymbol{r}}\vert)+\sum_{l,m<0}Y_{l}^{m}(\theta,\phi)\frac{1}{\sqrt{2}}[v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)+{\rm i}v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)]\nonumber \\
 &  & +\sum_{l,m>0}Y_{l}^{m}(\theta,\phi)\frac{(-1)^{m}}{\sqrt{2}}[v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)-{\rm i}v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)]\\
 & = & \sum_{l}Y_{l}^{m}(\theta,\phi)v_{l,m}^{{\rm AE}}(\boldsymbol{\vert\boldsymbol{r}}\vert)
\end{eqnarray}

\end_inset

with
\begin_inset Formula 
\begin{equation}
v_{l,m}^{{\rm AE}}(\boldsymbol{\vert\boldsymbol{r}}\vert)=\begin{cases}
\frac{1}{\sqrt{2}}[v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)+{\rm i}v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)] & m<0\\
v_{l}^{0}(\boldsymbol{\vert\boldsymbol{r}}\vert) & m=0\\
\frac{(-1)^{m}}{\sqrt{2}}[v_{l}^{m}(\boldsymbol{\vert\boldsymbol{r}}\vert)-{\rm i}v_{l}^{-m}(\boldsymbol{\vert\boldsymbol{r}}\vert)] & m>0
\end{cases}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsubsection
Rotations of spherical harmonics
\end_layout

\begin_layout Standard
A rotatiation of the 
\begin_inset Formula $Y_{l}^{m}(\theta,\phi)$
\end_inset

 in the active sense is described by the Wigner matrix
\begin_inset Formula 
\begin{eqnarray}
D_{mm^{\prime}}^{l}(\alpha,\beta,\gamma) & = & {\rm e}^{-{\rm i}m^{\prime}\alpha}d_{m^{\prime}m}^{l}(\beta){\rm e}^{-{\rm i}m\gamma}\\
d_{m^{\prime}m}^{l}(\beta) & = & [(l+m)!(l-m)!(l+m^{\prime})!(l-m^{\prime})!]^{\frac{1}{2}}\times\nonumber \\
 &  & \times\sum_{s}\frac{(-1)^{s}}{(l+m-s)!(l-m^{\prime}-s)!s!(m^{\prime}-m+s)!}\times\nonumber \\
 &  & \times[{\rm cos}(\frac{\beta}{2})]^{2l+m-m^{\prime}-2s}[{\rm sin}(\frac{\beta}{2})]^{m^{\prime}-m+2s}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $s$
\end_inset

 is summed over all factorials beeing non-negative, 
\begin_inset Formula $\alpha,\beta,\gamma$
\end_inset

 are the 3 Euler angles taking the unit vector 
\begin_inset Formula $\boldsymbol{r}(\theta,\phi)$
\end_inset

 to 
\begin_inset Formula $\boldsymbol{r}(\theta^{\prime},\phi^{\prime})$
\end_inset

.
 The formula is
\begin_inset Formula 
\begin{equation}
Y_{l}^{m}(\boldsymbol{r}^{\prime})=\sum_{m^{\prime}}D_{mm^{\prime}}^{l\ast}(\alpha,\beta,\gamma)Y_{l}^{m^{\prime}}(\boldsymbol{r})
\end{equation}

\end_inset


\end_layout

\begin_layout Subsubsection
Integral of three spherical harmonics
\end_layout

\begin_layout Standard
Since we will compute overlap integrals of functions expanded in spherical
 harmonics, we need evaluations of the form
\begin_inset Formula 
\begin{equation}
\int{\rm d}\phi\int{\rm d}\theta{\rm sin}(\theta)Y_{l_{1}}^{m_{1}}(\theta,\phi)Y_{l_{2}}^{m_{2}}(\theta,\phi)Y_{l_{3}}^{m_{3}}(\theta,\phi)=\sqrt{\frac{(2l_{1}+1)(2l_{2}+1)(2l_{3}+1)}{4\pi}}\left(\begin{array}{ccc}
l_{1} & l_{2} & l_{3}\\
0 & 0 & 0
\end{array}\right)\left(\begin{array}{ccc}
l_{1} & l_{2} & l_{3}\\
m_{1} & m_{2} & m_{3}
\end{array}\right)
\end{equation}

\end_inset

where 
\begin_inset Formula $\left(\begin{array}{ccc}
l_{1} & l_{2} & l_{3}\\
m_{1} & m_{2} & m_{3}
\end{array}\right)$
\end_inset

 is the Wigner-3j symbol.
 The integral is thus zero, if
\begin_inset Formula 
\begin{eqnarray}
1. &  & (l_{1}+l_{2}+l_{3})\;{\rm mod}\;2\neq0\\
2. &  & (m_{1}+m_{2}+m_{3})\neq0\\
3. &  & l_{3}\;{\rm not}\;{\rm such}\;{\rm that}\vert l_{1}-l_{2}\vert\leq l_{3}\leq\vert l_{1}+l_{2}\vert
\end{eqnarray}

\end_inset

The value can be computed using the package https://github.com/valandil/wignerSym
bols.
\end_layout

\begin_layout Subsection
The electron-phonon matrix elements
\end_layout

\begin_layout Subsubsection
Numerical formulation in terms of matrix multiplications
\end_layout

\begin_layout Standard
[TODO: has to be revised for spherical support grid]
\end_layout

\begin_layout Standard
There are easily 
\begin_inset Formula $\mathcal{O}(10^{3}-10^{4})$
\end_inset

 Fermi wave vectors per band, requiering that the above equation 
\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:a2FSymmetricTetra"

\end_inset

 is efficiently implemented.
 A good way to ensure this is to formulate the summations in terms of matrix
 multiplications.
 First, note that the numerical order of complexity for computing the electron
 phonon matrix elements is (dropping band indices for the following consideratio
n)
\begin_inset Formula 
\begin{eqnarray}
\mathcal{O}(g_{\boldsymbol{k}_{l},\boldsymbol{k}_{l^{\prime}}}^{\nu}(\boldsymbol{k}_{l^{\prime}}-\boldsymbol{k}_{l})) & \approx & \mathcal{O}(\frac{V_{{\rm UC}}}{N_{j}}\sum_{j}\psi_{\boldsymbol{k}_{l}}^{\ast}(\boldsymbol{r}_{j})\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}_{j})}{\delta u_{\boldsymbol{k}_{l^{\prime}}-\boldsymbol{k}_{l}\nu}}\psi_{\boldsymbol{k}_{l^{\prime}}}(\boldsymbol{r}_{j}))\\
 & = & \mathcal{O}(N_{\boldsymbol{k}_{l}}^{{\rm irred}}N_{\boldsymbol{k}_{l^{\prime}}}^{{\rm reducible}}N_{{\rm charge-FFT}}N_{{\rm Atoms}})
\end{eqnarray}

\end_inset

and thus is the most demanding step and should be the target of an efficient
 formulation.
 In particular the 
\begin_inset Formula $N_{{\rm charge-FFT}}$
\end_inset

 is easily of order 
\begin_inset Formula $10^{6}$
\end_inset

.
 Let us fix 
\begin_inset Formula $\boldsymbol{k}_{l}$
\end_inset

 and 
\begin_inset Formula $\boldsymbol{k}_{l^{\prime}}$
\end_inset

 (indicated by a superscript) and interpret
\begin_inset Formula 
\begin{eqnarray}
A_{\boldsymbol{r}_{j}}^{(\boldsymbol{k}_{l},\boldsymbol{k}_{l^{\prime}})} & = & \psi_{\boldsymbol{k}_{l}}^{\ast}(\boldsymbol{r}_{j})\psi_{\boldsymbol{k}_{l^{\prime}}}(\boldsymbol{r}_{j})\\
B_{\nu,\boldsymbol{r}_{j},}^{(\boldsymbol{k}_{l},\boldsymbol{k}_{l^{\prime}})} & = & \frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}_{j})}{\delta u_{\boldsymbol{k}_{l^{\prime}}-\boldsymbol{k}_{l}\nu}}
\end{eqnarray}

\end_inset

then 
\begin_inset Formula 
\begin{equation}
g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})=B_{\nu}^{(\boldsymbol{k}_{l},\boldsymbol{k}_{l^{\prime}})}(\cdot_{\boldsymbol{r}_{j}})A^{(\boldsymbol{k}_{l},\boldsymbol{k}_{l^{\prime}})}\label{eq:GkkpMatVec}
\end{equation}

\end_inset

So we have written the calculation as a matrix times vector operations.
 Alternatively
\begin_inset Formula 
\begin{eqnarray}
\tilde{A}_{\boldsymbol{k}_{l^{\prime}},\boldsymbol{r}_{j}} & = & \psi_{\boldsymbol{k}_{l^{\prime}}}(\boldsymbol{r}_{j})\\
\tilde{B}_{\boldsymbol{r}_{j},\nu\otimes\boldsymbol{k}_{l}} & = & \frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}_{j})}{\delta u_{\boldsymbol{k}_{l^{\prime}}-\boldsymbol{k}_{l}\nu}}\psi_{\boldsymbol{k}_{l}}^{\ast}(\boldsymbol{r}_{j})
\end{eqnarray}

\end_inset

then 
\begin_inset Formula 
\begin{equation}
g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})=(\tilde{A}\cdot\tilde{B})_{\boldsymbol{k}_{l^{\prime}},\nu\otimes\boldsymbol{k}_{l}}
\end{equation}

\end_inset

which is a matrix matrix operation.
 Let us consider the storage requirements.
 Since the wavefunctions can be computed on the fly the matrix vector operation
 is very memory efficient.
 Let us estimate 
\begin_inset Formula $\mathcal{O}(\boldsymbol{k}_{l})=N_{\boldsymbol{k}_{l}}^{{\rm irred}}\sim10^{2}$
\end_inset

, 
\begin_inset Formula $\mathcal{O}(\boldsymbol{k}_{l^{\prime}})=N_{\boldsymbol{k}_{l}}^{{\rm irred}}\sim10^{3}$
\end_inset

, 
\begin_inset Formula $\mathcal{O}(\boldsymbol{r}_{j})=N_{{\rm charge-FFT}}=10^{6}$
\end_inset

 and 
\begin_inset Formula $\mathcal{O}(\nu)=3N_{{\rm Atoms}}\sim10^{2}$
\end_inset

.
 Thus 
\begin_inset Formula $\mathcal{O}(B)=10^{2}\cdot10^{6}$
\end_inset

 while clearly 
\begin_inset Formula $\mathcal{O}(A)=10^{6}$
\end_inset

.
 Thus we have approximately 
\begin_inset Formula $8\times10^{8}$
\end_inset

 byte for single precision complex data.
 This is order 1GB and easily fits into modern computer memory.
\end_layout

\begin_layout Standard
The matrix-matrix operation requires pre-calculation and storage of 
\begin_inset Formula $\mathcal{O}(\tilde{A})=\mathcal{O}(\boldsymbol{k}_{l^{\prime}})\mathcal{O}(\boldsymbol{r}_{j})\sim10^{3}\cdot10^{6}$
\end_inset

 plus 
\begin_inset Formula $\mathcal{O}(\tilde{B})=\mathcal{O}(\boldsymbol{r}_{j})\mathcal{O}(\nu\otimes\boldsymbol{k}_{l})=10^{6}\cdot10^{2}\cdot10^{2}$
\end_inset

.
 This means a storage requirement of 
\begin_inset Formula $\sim10^{10}$
\end_inset

 complex data elements.
 In single precision, this means 
\begin_inset Formula $8\times10^{10}$
\end_inset

 byte for single precision complex data.
 This is order 100GB and thus, too much to be practical.
 Even for smaller systems, this can be excessive because a denser 
\begin_inset Formula $k$
\end_inset

 resolution is nescsseary.
 Thus, we determine, it is better to generate data on the fly as in Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:GkkpMatVec"

\end_inset

 even though matrix operations are usually more efficient.
\end_layout

\begin_layout Subsubsection
Units
\end_layout

\begin_layout Standard
The units of the gkkp matrix elements are with wavefunctions being the inverse
 square root of states per volume of the unit cell and the displacement
 potential 
\begin_inset Formula $\nabla_{\mu\boldsymbol{R}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

 being determined by Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand eqref
reference "eq:DisplacementPotentialLinear"

\end_inset

 has units eV per angstrom.
 Consquently, its Fourier transform Eq.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "eq:ModeDisplacementPotential"

\end_inset

 has units
\begin_inset Formula 
\begin{equation}
[\frac{\delta v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})}{\delta u_{\boldsymbol{q}\nu}}]=[\nabla_{\mu\boldsymbol{R}}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})]=\frac{{\rm eV}}{{\rm \AA}}
\end{equation}

\end_inset

Thus
\begin_inset Formula 
\begin{equation}
\sqrt{\frac{\hbar}{2{\rm u}\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}}}g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})\sim{\rm eV}
\end{equation}

\end_inset

where if the numerical value of 
\begin_inset Formula $\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}$
\end_inset

 is 1, the prefactor is
\begin_inset Formula 
\begin{eqnarray}
\sqrt{\frac{\hbar}{2{\rm u}{\rm THz}}} & = & \sqrt{\frac{\hbar\cdot{\rm s}}{2{\rm u}\cdot2\pi\times10^{12}}}=\sqrt{\frac{1.0545718\times10^{-34}{\rm m}^{2}{\rm kg}}{4\pi\times1.660539040\times10^{-27}{\rm kg}10^{12}}}\\
 &  & =\sqrt{\frac{1.0545718\times10^{-34}\times10^{20}{\rm \AA}^{2}}{4\pi\times1.660539040\times10^{-27}\times10^{12}}}=\sqrt{\frac{10.545718}{4\pi\times1.660539040}}{\rm \AA}
\end{eqnarray}

\end_inset

thus the numerical conversion factor is
\begin_inset Formula 
\begin{equation}
\sqrt{\frac{\hbar}{2{\rm u}\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}}}\approx\frac{0.71090013980905870172}{\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}/{\rm THz}}{\rm \AA}
\end{equation}

\end_inset

now, since we measure 
\begin_inset Formula $\rho(E_{{\rm F}})\sim\tilde{w}_{l^{\prime}}^{i^{\prime}}\sim\tilde{w}_{l}^{i}\sim{\rm eV}^{-1}$
\end_inset

 and 
\begin_inset Formula $\delta(\hbar\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}-\omega)\sim{\rm eV}^{-1}$
\end_inset

 we fortunately find the factor 
\begin_inset Formula $1/\hbar$
\end_inset

 from the self-energy, so that 
\begin_inset Formula 
\begin{eqnarray}
\alpha^{2}\,F(\omega) & \sim & \rho(E_{{\rm F}})^{-1}\frac{\vert g_{\boldsymbol{k}_{li},\boldsymbol{k}_{i^{\prime}l^{\prime}}}^{i,i^{\prime}\nu}(\boldsymbol{k}_{i^{\prime}l^{\prime}}-\boldsymbol{k}_{li})\vert^{2}}{2\hbar\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}}\delta(\hbar\varOmega_{\boldsymbol{k}_{li}-\boldsymbol{k}_{i^{\prime}l^{\prime}}\nu}-\omega)\tilde{w}_{l}^{i}\tilde{w}_{l^{\prime}}^{i^{\prime}}\\
 & \sim & 1
\end{eqnarray}

\end_inset

so 
\begin_inset Formula $\alpha^{2}\,F(\omega)$
\end_inset

 is dimensionless
\end_layout

\begin_layout Subsection
PAW matrix elements
\end_layout

\begin_layout Standard
In practice, the wavefunctions are not purely described in terms of plane
 waves, because of the singularity at the nuclear core.
 Pseudo potential methods have been introduced do replace the sharp core
 potential with a smoother one for the states of interrest around the Fermi
 level and thereby make make calculations feasiable.
 On the other hand for many flavors of pseudo potentials and pseudo wavefunction
s, this means we have consider the transformation that allows to reconstruct
 realsistic electron-phonon matrix elements.
\end_layout

\begin_layout Standard
One of the most used methods to construct pseudo potentials is the projector
 augumented wave method.
 The all electron wavefunction 
\begin_inset Formula $\psi_{\boldsymbol{k}n}$
\end_inset

 is given by
\begin_inset Formula 
\begin{equation}
\vert\psi_{\boldsymbol{k}n}\rangle=\hat{\mathcal{T}}\vert\tilde{\psi}_{\boldsymbol{k}n}\rangle
\end{equation}

\end_inset

where
\begin_inset Formula 
\begin{equation}
\hat{\mathcal{T}}=1+\sum_{i}(\vert\phi_{i}\rangle-\vert\tilde{\phi}_{i}\rangle)\langle\tilde{p}_{i}\vert\tilde{\psi}_{\boldsymbol{k}n}\rangle
\end{equation}

\end_inset

The projector 
\begin_inset Formula $\tilde{p}_{i}$
\end_inset

 is applied to the pseudo wavefunction 
\begin_inset Formula $\vert\tilde{\psi}_{\boldsymbol{k}n}\rangle$
\end_inset

 either in real or reciprocal space.
\end_layout

\begin_layout Subsection
Velocities
\end_layout

\begin_layout Standard
For compuing the gradient field
\begin_inset Formula $\nabla\varepsilon_{\boldsymbol{k}i}$
\end_inset

 we use the Fourier transform
\begin_inset Formula 
\begin{eqnarray}
\varepsilon_{\boldsymbol{k}i} & = & \sum_{\boldsymbol{R}}H_{i}(\boldsymbol{R}){\rm e}^{-{\rm i}\boldsymbol{R}\cdot\boldsymbol{k}}\\
\nabla_{\boldsymbol{k}}\varepsilon_{\boldsymbol{k}i} & = & -\sum_{\boldsymbol{R}}H_{i}(\boldsymbol{R}){\rm i}\boldsymbol{R}{\rm e}^{-{\rm i}\boldsymbol{R}\cdot\boldsymbol{k}}\\
 &  & ={\rm IFFT}[-{\rm i}A\cdot\tilde{\boldsymbol{R}}H_{i}(A\cdot\tilde{\boldsymbol{R}})]
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $A$
\end_inset

 is the lattice matrix and 
\begin_inset Formula $\tilde{\boldsymbol{R}}$
\end_inset

 consists of purely intergers.
 Here we need to be careful with units.
 The density of states per unit cell is defined as
\begin_inset Formula 
\begin{eqnarray}
\rho(\omega) & = & \frac{1}{N_{\boldsymbol{k}}}\sum_{\boldsymbol{k}i}\delta(\varepsilon_{\boldsymbol{k}i}-\omega)\\
 & = & \frac{V_{{\rm uc}}}{(2\pi)^{3}}\sum_{i}\int_{{\rm BZ}}{\rm d}\boldsymbol{k}\delta(\varepsilon_{\boldsymbol{k}i}-\omega)\\
 &  & \approx\frac{1}{N_{\boldsymbol{k}}}\sum_{\boldsymbol{k}i}\frac{1}{E}\theta(\frac{E}{2}-\vert\omega-\varepsilon_{\boldsymbol{k}i}\vert)\\
 & = & \frac{V_{{\rm uc}}}{(2\pi)^{3}}\sum_{i}\int_{{\rm FS}}\frac{{\rm d}^{2}\boldsymbol{k}_{f}}{\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert}\\
 &  & \approx\frac{V_{{\rm uc}}}{(2\pi)^{3}}\sum_{\boldsymbol{k}_{f}i}\frac{w_{\boldsymbol{k}_{f}}}{\vert\nabla\varepsilon_{\boldsymbol{k}_{f}i}\vert}
\end{eqnarray}

\end_inset

And of cause
\begin_inset Formula 
\begin{eqnarray}
N_{e} & = & \int_{-\infty}^{E_{f}}{\rm d}\omega\rho(\omega)\\
 & = & \int_{-\infty}^{E_{f}}{\rm d}\omega\sum_{\boldsymbol{k}i}\delta(\varepsilon_{\boldsymbol{k}i}-\omega)=\sum_{\boldsymbol{k}i\vert\varepsilon_{\boldsymbol{k}i}<E_{f}}1
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsection
The mass tensor
\end_layout

\begin_layout Subsubsection
Units
\end_layout

\begin_layout Standard
We compute the derivative of the dispersion which has units of
\begin_inset Formula 
\begin{equation}
[\partial_{k_{l}}\partial_{k_{l^{\prime}}}\varepsilon_{\boldsymbol{k}i}]={\rm eV}\times{\rm \AA}^{2}
\end{equation}

\end_inset

comparison with the second term in the taylor exapnsion implies that
\begin_inset Formula 
\begin{eqnarray}
M_{ll^{\prime}}^{\ast-1} & = & \frac{1}{\hbar^{2}}\partial_{k_{l}}\partial_{k_{l^{\prime}}}\varepsilon_{\boldsymbol{k}i}\\
 & = & \frac{10^{32}}{(6.582119514)^{2}}\frac{{\rm \AA}^{2}}{{\rm eV^{2}}{\rm s}^{2}}X{\rm eV}\\
 & = & \frac{10^{32}}{(6.582119514)^{2}}\frac{10^{-20}{\rm m}^{2}}{{\rm eV}{\rm s}^{2}}X\\
 & = & \frac{10^{32}\times10^{-20}10^{-31}}{(6.582119514)^{2}}\frac{{\rm m}^{2}}{{\rm eV}{\rm s}^{2}}\frac{9.10938356{\rm kg}}{{\rm m}_{0}^{{\rm e}}}X\\
 & = & \frac{10^{32}\times10^{-20}10^{-31}}{(6.582119514)^{2}}9.10938356\times6.2415093433\times10^{18}\frac{1}{{\rm m}_{0}^{{\rm e}}}X\\
 & = & \frac{10^{-1}}{(6.582119514)^{2}}9.10938356\times6.2415093433\frac{1}{{\rm m}_{0}^{{\rm e}}}X\\
 & \approx & 0.1312342176\frac{1}{{\rm m}_{0}^{{\rm e}}}X
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $X$
\end_inset

 is the numerical value of 
\begin_inset Formula $\partial_{k_{l}}\partial_{k_{l^{\prime}}}\varepsilon_{\boldsymbol{k}i}$
\end_inset

.
 Thus to get the mass tensor, we need to invert the matrix 
\begin_inset Formula $\partial_{k_{l}}\partial_{k_{l^{\prime}}}\varepsilon_{\boldsymbol{k}i}$
\end_inset

 and scale by the above numerical unit inverse 
\begin_inset Formula 
\begin{equation}
\frac{M_{ll^{\prime}}^{\ast}}{{\rm m}_{0}^{{\rm e}}}=7.61996389393771\times[\partial_{k}\partial_{k}\varepsilon_{\boldsymbol{k}i}]_{ll^{\prime}}^{-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Lattice basis
\end_layout

\begin_layout Standard
Let us consider the scalar product of the cartesian vectors
\begin_inset Formula 
\begin{eqnarray}
\boldsymbol{k}^{{\rm T}}\cdot\boldsymbol{R} & = & c\\
\tilde{\boldsymbol{k}}^{{\rm T}}\cdot B^{{\rm T}}\cdot A\cdot\tilde{\boldsymbol{R}} & = & c=\tilde{\boldsymbol{k}}^{{\rm T}}\cdot\tilde{\boldsymbol{R}}\\
(B\cdot\tilde{\boldsymbol{k}})^{{\rm T}}\cdot A\cdot\tilde{\boldsymbol{R}} & = & c
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $B$
\end_inset

 is the reciprocal lattice basis and 
\begin_inset Formula $A$
\end_inset

 is the real space lattice basis.
 Clearly 
\begin_inset Formula $B^{{\rm T}}\cdot A=1=A^{{\rm T}}\cdot B$
\end_inset

.
 Thus
\begin_inset Formula 
\begin{equation}
B^{{\rm T}}=A^{-1}\Leftrightarrow A\cdot B^{{\rm T}}=1
\end{equation}

\end_inset

Now let us consider the effect of symmetry operations
\begin_inset Formula 
\begin{eqnarray}
\boldsymbol{k}^{{\rm T}}\cdot S^{-1}S\cdot\boldsymbol{R} & = & c\\
(S\cdot\boldsymbol{k})^{{\rm T}}S\cdot\boldsymbol{R} & = & c\\
(S\cdot\boldsymbol{k})^{{\rm T}}A\cdot B^{{\rm T}}\cdot S\cdot A\cdot\tilde{\boldsymbol{R}} & = & c\\
(S\cdot B\cdot\tilde{\boldsymbol{k}})^{{\rm T}}A\cdot\tilde{S}\cdot\tilde{\boldsymbol{R}} & = & c\\
(A^{{\rm T}}\cdot S\cdot B\cdot\tilde{\boldsymbol{k}})^{{\rm T}}\cdot\tilde{S}\cdot\tilde{\boldsymbol{R}} & = & c\\
(\tilde{S}_{k}\cdot\tilde{\boldsymbol{k}})^{{\rm T}}\cdot\tilde{S}\cdot\tilde{\boldsymbol{R}} & = & c\\
\tilde{\boldsymbol{k}}^{{\rm T}}\cdot\tilde{S}_{k}^{{\rm T}}\cdot\tilde{S}\cdot\tilde{\boldsymbol{R}} & = & c
\end{eqnarray}

\end_inset

by which we see
\begin_inset Formula 
\begin{equation}
\tilde{S}_{k}^{{\rm T}}\cdot\tilde{S}=1
\end{equation}

\end_inset

with
\begin_inset Formula 
\begin{eqnarray}
B^{{\rm T}}\cdot S\cdot A & = & \tilde{S}\\
A^{{\rm T}}\cdot S\cdot B & = & \tilde{S}_{k}\leftrightarrow\tilde{S}^{{\rm T}}=\tilde{S}_{k}^{-1}2
\end{eqnarray}

\end_inset

even though the matrices are not nessecary unitary.
\end_layout

\begin_layout Subsection
Displacements in a lattice with non-orthogonal basis vectors
\end_layout

\begin_layout Standard
In order to minimize the number of symmetry unrelated displacements, we
 seek to use displacments along the basis vectors of the cell.
 Thus, it would be beneficial not to displace in 
\begin_inset Formula $\mu=\alpha,[x,y,z]$
\end_inset

 but some linear combination of these cartesian vector displacements 
\begin_inset Formula $\underbar{v}_{\mu\boldsymbol{R}-\boldsymbol{R}_{0}}$
\end_inset

 such that
\begin_inset Formula 
\begin{equation}
\underbar{v}_{\tilde{\mu}\boldsymbol{R}-\boldsymbol{R}_{0}}=\sum_{\mu}A_{\tilde{\mu},\mu}^{-1}\underbar{v}_{\mu\boldsymbol{R}-\boldsymbol{R}_{0}}
\end{equation}

\end_inset

where 
\begin_inset Formula $\tilde{\mu}$
\end_inset

 is 
\begin_inset Formula $[x,y,z]$
\end_inset

 in the possibly non-orthogonal coordinate system of the lattice or 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula 
\begin{equation}
\nabla_{(\boldsymbol{R}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})=\sum_{\tilde{\mu}}A_{\mu,\tilde{\mu}}\nabla_{(\boldsymbol{R}\tilde{\mu})}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})
\end{equation}

\end_inset

which is clear from the linearety of the derivative operator.
 In practice 
\begin_inset Formula $\tilde{\Delta}$
\end_inset

 is finite and the requirement arises that the displacements in the direct
 lattice can be chosen such that 1) 
\begin_inset Formula $\tilde{\Delta}$
\end_inset

 is small enough such that 
\begin_inset Formula $\{v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r})-v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}+\tilde{\Delta}\underbar{v}_{\tilde{\mu}\boldsymbol{R}}](\boldsymbol{r})\}/\tilde{\Delta}$
\end_inset

 is in the linear regeme and 2) the effective 
\begin_inset Formula $\Delta$
\end_inset

 is each direction is not too small such that 
\begin_inset Formula $\nabla_{(\boldsymbol{R}\mu)}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r})$
\end_inset

 is noisy.
 We expect this problem to occur only if the lattice basis has very strongly
 overlapping basis vectors.
\end_layout

\begin_layout Subsection
Reconstruction of Bloch wave functions at reducible 
\begin_inset Formula $\boldsymbol{k}$
\end_inset

 in a plane wave represenation
\end_layout

\begin_layout Standard
Electronic structure codes usually try to reduce the workload by only computing
 wave functions 
\begin_inset Formula $\psi_{\boldsymbol{k}i}(\boldsymbol{r})$
\end_inset

 that are in the irreducible Brillouin zone.
 Here we describe how the symmetry related wave functions are reconstructed.
 Let us start with the plane wave expansion
\begin_inset Formula 
\begin{eqnarray}
\psi_{\boldsymbol{k}i}(\boldsymbol{r}) & = & \sum_{\boldsymbol{G}}c_{\boldsymbol{k}+\boldsymbol{G}}^{i}{\rm e}^{-{\rm i}(\boldsymbol{k}+\boldsymbol{G})\boldsymbol{r}}\\
 &  & =u_{\boldsymbol{k}i}(\boldsymbol{r}){\rm e}^{-{\rm i}\boldsymbol{k}\cdot\boldsymbol{r}}
\end{eqnarray}

\end_inset

Electronic structure codes usually compute the periodic part of a Bloch
 wavefunction 
\begin_inset Formula $u_{\boldsymbol{k}i}(\boldsymbol{r})$
\end_inset

.
 Let us assome 
\begin_inset Formula $\boldsymbol{k}^{\prime}=\{g|\boldsymbol{\tau}\}\boldsymbol{k}$
\end_inset

 then we have
\begin_inset Formula 
\begin{eqnarray}
u_{\boldsymbol{k}^{\prime}i}(\boldsymbol{r}) & = & \{g|\boldsymbol{\tau}\}\sum_{\boldsymbol{G}}c_{\boldsymbol{k}+\boldsymbol{G}}^{i}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot\boldsymbol{r}}\\
 & = & \sum_{\boldsymbol{G}}c_{\boldsymbol{k}+\boldsymbol{G}}^{i}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot(g\cdot\boldsymbol{r}+\boldsymbol{\tau})}\\
 & = & \sum_{\boldsymbol{G}}c_{\boldsymbol{k}+\boldsymbol{G}}^{i}{\rm e}^{-{\rm i}g^{-1}\cdot\boldsymbol{G}\cdot\boldsymbol{r}}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot\boldsymbol{\tau}}\\
 & = & \sum_{\boldsymbol{G}^{\prime}}[c_{\boldsymbol{k}^{\prime}+\boldsymbol{G}^{\prime}}^{i}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot\boldsymbol{\tau}}]{\rm e}^{-{\rm i}\boldsymbol{G}^{\prime}\cdot\boldsymbol{r}}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $c_{\boldsymbol{k}^{\prime}+\boldsymbol{G}^{\prime}}^{i}$
\end_inset

 is a rearrangement of the set 
\begin_inset Formula $c_{\boldsymbol{k}+\boldsymbol{G}}^{i}$
\end_inset

 where symmetry related 
\begin_inset Formula $\boldsymbol{G}^{\prime}$
\end_inset

 has to be located in the original set 
\begin_inset Formula $\boldsymbol{G}$
\end_inset

.
\end_layout

\begin_layout Standard
Let us discuss an example.
 Say we have a tetragonal cell, one band, 3 irreducible k points and 5 or
 6 plane waves
\begin_inset Formula 
\begin{eqnarray}
\boldsymbol{k}_{0}=(0.125,0.125,0) & : & \{c_{\boldsymbol{k}_{0}},c_{\boldsymbol{k}_{0}-\boldsymbol{x}},c_{\boldsymbol{k}_{0}-\boldsymbol{y}},c_{\boldsymbol{k}_{0}-\boldsymbol{z}},c_{\boldsymbol{k}_{0}+\boldsymbol{z}}\}\\
\boldsymbol{k}_{1}=(0.375,0.125,0) & : & \{c_{\boldsymbol{k}_{1}},c_{\boldsymbol{k}_{1}-\boldsymbol{x}},c_{\boldsymbol{k}_{1}+\boldsymbol{z}},c_{\boldsymbol{k}_{1}-\boldsymbol{y}+\boldsymbol{z}},c_{\boldsymbol{k}_{1}-\boldsymbol{z}},c_{\boldsymbol{k}_{1}-\boldsymbol{y}-\boldsymbol{z}}\}\\
\boldsymbol{k}_{2}=(0.375,0.375,0) & : & \{c_{\boldsymbol{k}_{2}},c_{\boldsymbol{k}_{2}-\boldsymbol{x}},c_{\boldsymbol{k}_{2}-\boldsymbol{y}},c_{\boldsymbol{k}_{2}-\boldsymbol{x}-\boldsymbol{y}},c_{\boldsymbol{k}_{2}-\boldsymbol{z}},c_{\boldsymbol{k}_{2}+\boldsymbol{z}}\}
\end{eqnarray}

\end_inset

which means, e.g.
\begin_inset Formula 
\begin{eqnarray}
u_{\boldsymbol{k}_{0}}(\boldsymbol{r}) & = & c_{\boldsymbol{k}_{0}}+c_{\boldsymbol{k}_{0}-\boldsymbol{x}}{\rm e}^{{\rm i}\boldsymbol{x}\cdot\boldsymbol{r}}+c_{\boldsymbol{k}_{0}-\boldsymbol{y}}{\rm e}^{{\rm i}\boldsymbol{y}\cdot\boldsymbol{r}}+c_{\boldsymbol{k}_{0}-\boldsymbol{z}}{\rm e}^{{\rm i}\boldsymbol{z}\cdot\boldsymbol{r}}+c_{\boldsymbol{k}_{0}+\boldsymbol{z}}{\rm e}^{-{\rm i}\boldsymbol{z}\cdot\boldsymbol{r}}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\boldsymbol{x},\boldsymbol{y}$
\end_inset

 and 
\begin_inset Formula $\boldsymbol{z}$
\end_inset

 are displacements of one lattice vector in 
\begin_inset Formula $x,y$
\end_inset

 or 
\begin_inset Formula $z$
\end_inset

, respecetively.
 These three vectors are connected with 16 symmetry operations to a regular
 
\begin_inset Formula $4x4x1$
\end_inset

 grid shifted by 
\begin_inset Formula $1/8$
\end_inset

 in 
\begin_inset Formula $x$
\end_inset

 and 
\begin_inset Formula $y$
\end_inset

.
 The vector 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $\boldsymbol{k}_{0}$
\end_inset

 is connected to the reducible vector 
\begin_inset Formula 
\begin{equation}
\boldsymbol{k}_{0}^{2}=(-0.125,0.125,0)
\end{equation}

\end_inset

by the symmetry operation
\begin_inset Formula 
\begin{eqnarray}
S^{3} & = & \left(\begin{array}{ccc}
0 & -1 & 0\\
1 & 0 & 0\\
0 & 0 & -1
\end{array}\right)\quad\tau=(0\,0\,0)\\
\boldsymbol{k}_{0}^{2} & = & S^{3}\cdot\boldsymbol{k}_{0}
\end{eqnarray}

\end_inset

We have
\begin_inset Formula 
\begin{eqnarray}
u_{\boldsymbol{k}_{0}^{2}}(\boldsymbol{r}) & = & u_{S^{3}\cdot\boldsymbol{k}_{0}}(\boldsymbol{r})=\sum_{\boldsymbol{G}}c_{S^{3}\cdot\boldsymbol{k}_{0}+\boldsymbol{G}}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot\boldsymbol{r}}\\
 &  & =\sum_{\boldsymbol{G}}c_{S^{3}\cdot(\boldsymbol{k}_{0}+\boldsymbol{G})}{\rm e}^{-{\rm i}S^{3}\boldsymbol{G}\cdot\boldsymbol{r}}\\
 & \equiv & \sum_{\boldsymbol{G}}\tilde{c}_{\boldsymbol{k}_{0}^{2}+\boldsymbol{G}}{\rm e}^{-{\rm i}\boldsymbol{G}\cdot\boldsymbol{r}}
\end{eqnarray}

\end_inset

In order to identify 
\begin_inset Formula $\tilde{c}_{\boldsymbol{k}_{0}^{2}+\boldsymbol{G}}$
\end_inset

 we simpy compare the linear coefficients of the linear independent plane
 waves.
 Note that the symmetry operation is not only a rotation.
 We need to account for non-symmorphic symmetry operations and inversions
 by
\begin_inset Formula 
\begin{eqnarray}
u_{\boldsymbol{k}^{\prime}}(\boldsymbol{r}) & = & u_{S\cdot\boldsymbol{k}}(\boldsymbol{r}+\tau)\quad{\rm non-symmorphic}\\
u_{\boldsymbol{k}^{\prime}}(\boldsymbol{r}) & = & u_{S\cdot\boldsymbol{k}}^{\ast}(\boldsymbol{r}+\tau)\quad{\rm inversion}
\end{eqnarray}

\end_inset

 and find in this particular case
\begin_inset Formula 
\begin{equation}
\tilde{c}_{\boldsymbol{k}_{0}^{2}+\boldsymbol{G}}:\{c_{\boldsymbol{k}_{0}^{2}}^{\ast},c_{\boldsymbol{k}_{0}^{2}-\boldsymbol{y}}^{\ast},c_{\boldsymbol{k}_{0}^{2}+\boldsymbol{x}}^{\ast},c_{\boldsymbol{k}_{0}^{2}+\boldsymbol{z}}^{\ast},c_{\boldsymbol{k}_{0}^{2}-\boldsymbol{z}}^{\ast}\}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Fourier interpolation of the band structure
\end_layout

\begin_layout Standard
For finding a smoother sampling of the Fermi surface, we need to interpolate
 the band structure and a good way of doing this for the perpdic data is
 the Fourier based interpolation scheme.
 Here we use
\begin_inset Formula 
\begin{equation}
\varepsilon(\bar{\boldsymbol{k}})=\sum_{\boldsymbol{R}}\{\sum_{\boldsymbol{k}}\varepsilon(\boldsymbol{k}){\rm e}^{{\rm -}\boldsymbol{k}\cdot\boldsymbol{R}}\}{\rm e}^{\bar{\boldsymbol{k}}\cdot\boldsymbol{R}}
\end{equation}

\end_inset

where the grid size of 
\begin_inset Formula 
\begin{equation}
\varepsilon(\boldsymbol{R})=\sum_{\boldsymbol{k}}\varepsilon(\boldsymbol{k}){\rm e}^{{\rm -}\boldsymbol{k}\cdot\boldsymbol{R}}
\end{equation}

\end_inset

will be zero-padded to the desired density indicated with a bar.
 Thus we use
\begin_inset Formula 
\begin{eqnarray}
\varepsilon(\boldsymbol{R}) & = & {\rm FFT}\{\varepsilon(\boldsymbol{k})\}\\
\varepsilon(\bar{\boldsymbol{R}}) & = & {\rm Zero-Pad}\{\varepsilon(\boldsymbol{R})\}\\
\varepsilon(\bar{\boldsymbol{k}}) & = & {\rm IFFT}\{\varepsilon(\bar{\boldsymbol{R}})\}
\end{eqnarray}

\end_inset

 Since 
\begin_inset Formula $\varepsilon(\boldsymbol{k})$
\end_inset

 is real, 
\begin_inset Formula $\varepsilon(-\boldsymbol{R})^{\ast}=\varepsilon(\boldsymbol{R})$
\end_inset

.
 A bit of a headache are the grid shifts, 
\begin_inset Formula $\boldsymbol{k}_{0}$
\end_inset

 and 
\begin_inset Formula $\bar{\boldsymbol{k}}_{0}$
\end_inset

 that are frequencently used
\begin_inset Formula 
\begin{eqnarray}
\varepsilon(R_{x},R_{y},R_{z}) & = & {\rm e}^{{\rm -}\frac{{\boldsymbol{k}_{0}}_{x}\cdot R_{x}}{N_{kx}}\frac{{\boldsymbol{k}_{0}}_{y}\cdot R_{y}}{N_{ky}}\frac{{\boldsymbol{k}_{0}}_{z}\cdot R_{z}}{N_{kz}}}\sum_{i,j,l}[\varepsilon(\boldsymbol{k})]{\rm e}^{{\rm -}\frac{i\cdot R_{x}}{N_{kx}}\frac{j\cdot R_{y}}{N_{ky}}\frac{l\cdot R_{z}}{N_{kz}}}\\
\varepsilon(\bar{\boldsymbol{k}}) & = & {\rm FFT}\bigl({\rm Zero-Pad}\{{\rm FFT}\{\varepsilon(\boldsymbol{k})\}{\rm e}^{{\rm -}\frac{{\boldsymbol{k}_{0}}_{x}\cdot R_{x}}{N_{kx}}\frac{{\boldsymbol{k}_{0}}_{y}\cdot R_{y}}{N_{ky}}\frac{{\boldsymbol{k}_{0}}_{z}\cdot R_{z}}{N_{kz}}}\}{\rm e}^{\frac{{\mbox{\bar{\boldsymbol{k}}_{0}}}_{x}\cdot\bar{R}_{x}}{\bar{N}_{kx}}\frac{{\mbox{\bar{\boldsymbol{k}}_{0}}}_{y}\cdot\bar{R}_{y}}{\bar{N}_{ky}}\frac{{\mbox{\bar{\boldsymbol{k}}_{0}}}_{z}\cdot\bar{R}_{z}}{\bar{N}_{kz}}}\bigr)
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsection
Nesting function
\end_layout

\begin_layout Standard
As a prelimnary exercise, we compute the Nesting function
\begin_inset Formula 
\begin{equation}
\chi_{nn^{\prime}}(\boldsymbol{q})=\sum_{\boldsymbol{k}}\delta(\varepsilon_{\boldsymbol{k}n}-\varepsilon_{F})\delta(\varepsilon_{\boldsymbol{k}+\boldsymbol{q}n^{\prime}}-\varepsilon_{F})
\end{equation}

\end_inset

Note that in the contiunum limit for 
\begin_inset Formula $\boldsymbol{k}$
\end_inset

 this can be written as
\begin_inset Formula 
\begin{eqnarray}
\chi_{nn^{\prime}}(\boldsymbol{q}) & = & \int_{{\rm BZ}}{\rm d}^{3}k\delta(\varepsilon_{\boldsymbol{k}n}-\varepsilon_{F})\delta(\varepsilon_{\boldsymbol{k}+\boldsymbol{q}n^{\prime}}-\varepsilon_{F})\\
 & = & \sum_{\boldsymbol{G}}\int_{{\rm BZ}}{\rm d}^{3}k\int_{{\rm BZ}}{\rm d}^{3}k^{\prime}\delta(\boldsymbol{k}^{\prime}-\boldsymbol{k}-\boldsymbol{q}+\boldsymbol{G})\delta(\varepsilon_{\boldsymbol{k}}-\varepsilon_{F})\delta(\varepsilon_{\boldsymbol{k}^{\prime}n^{\prime}}-\varepsilon_{F})\\
 & = & \int_{\varepsilon_{\boldsymbol{k}n}=\varepsilon_{F}}\frac{{\rm d}^{2}k}{\vert\nabla\varepsilon_{\boldsymbol{k}n}\vert}\int_{\varepsilon_{\boldsymbol{k}^{\prime}n^{\prime}}=\varepsilon_{F}}\frac{{\rm d}^{2}k^{\prime}}{\vert\nabla\varepsilon_{\boldsymbol{k}^{\prime}n^{\prime}}\vert}\sum_{\boldsymbol{G}}\delta[\boldsymbol{q}-(\boldsymbol{k}^{\prime}-\boldsymbol{k})+\boldsymbol{G}]\\
 & \approx & \sum_{ij}w_{i}^{n^{\prime}}w_{j}^{n}\sum_{\boldsymbol{G}}\delta[\boldsymbol{q}-(\boldsymbol{k}_{i}^{\prime}-\boldsymbol{k}_{j})+\boldsymbol{G}]
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $w_{i}$
\end_inset

 are the combined weights 
\begin_inset Formula ${\rm d}^{2}k/\vert\nabla\varepsilon_{\boldsymbol{k}}\vert$
\end_inset

 at the iso-surface 
\begin_inset Formula $\varepsilon_{F}$
\end_inset

.
 The sum over 
\begin_inset Formula $\boldsymbol{G}$
\end_inset

 effectively maps back to the first BZ in that is assures that if 
\begin_inset Formula $\boldsymbol{q}-(\boldsymbol{k}_{i}^{\prime}-\boldsymbol{k}_{j})$
\end_inset

 is any lattice vector the contribution will be recorded.
 Furthermore, since weights are the same for symmetry related iso-
\begin_inset Formula $\boldsymbol{k}$
\end_inset

 points
\begin_inset Formula 
\begin{equation}
\chi_{nn^{\prime}}(\boldsymbol{q})\approx\sum_{i,j\in{\rm irred}}w_{i}^{n^{\prime}}w_{j}^{n}\sum_{\boldsymbol{G}}\sum_{S_{i}S_{j}}\delta[\boldsymbol{q}-(S_{i}\boldsymbol{k}_{i}^{\prime}-S_{j}\boldsymbol{k}_{j})+\boldsymbol{G}]
\end{equation}

\end_inset

with 
\begin_inset Formula $S_{i}$
\end_inset

 begin the symmetry operations taking the irreducible 
\begin_inset Formula $\boldsymbol{k}_{i}$
\end_inset

 to the elements of the star.
 The way to read the formula above numerically is to compute for each combinatio
n of points in the irreducible zone the product weight 
\begin_inset Formula $w_{i}^{n^{\prime}}w_{j}^{n}$
\end_inset

 and add it to
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
 
\begin_inset Formula $\chi(\boldsymbol{q})$
\end_inset

 at
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit
 the 
\begin_inset Formula $\boldsymbol{q}$
\end_inset

 points of
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
 that can be generated by any star operation 
\begin_inset Formula $S_{i}\boldsymbol{k}_{i}^{\prime}-S_{j}\boldsymbol{k}_{j}$
\end_inset

 mapped back to the 1.
 Brillouin zone.
 Points that are not on the border of the irreducible zone have a star of
 full dimension of the group.
 In that case, we can use the group property
\begin_inset Formula 
\begin{eqnarray}
\{\boldsymbol{q}\} & = & \sum_{\boldsymbol{G}}\sum_{S_{i}S_{j}}(S_{i}\boldsymbol{k}_{i}^{\prime}-S_{j}\boldsymbol{k}_{j})+\boldsymbol{G}\in1.{\rm BZ}\\
 & = & \sum_{\boldsymbol{G}^{\prime}}\sum_{S_{i}^{\prime}S_{j}}S_{j}(S_{i}^{\prime}\boldsymbol{k}_{i}^{\prime}-\boldsymbol{k}_{j}+\boldsymbol{G}^{\prime})\\
 & = & \sum_{S_{j}}S_{j}\{\boldsymbol{q}\}_{{\rm irred}}
\end{eqnarray}

\end_inset

Thus, as one would expect from the originial definition, the nesting function
 
\begin_inset Formula $\chi_{nn^{\prime}}(\boldsymbol{q})$
\end_inset

 is symmetric and we only need to compute irreducible 
\begin_inset Formula $\{\boldsymbol{q}\}_{{\rm irred}}=\sum_{\boldsymbol{G}}\sum_{S_{i}^{\prime}}(S_{i}^{\prime}\boldsymbol{k}_{i}^{\prime}-\boldsymbol{k}_{j})+\boldsymbol{G}\in1.{\rm BZ}$
\end_inset

.
\begin_inset Formula 
\begin{equation}
\chi_{nn^{\prime}}(\{\boldsymbol{q}\}_{{\rm irred}})\approx\sum_{i,j\in{\rm irred}}w_{i}^{n^{\prime}}w_{j}^{n}\sum_{\boldsymbol{G}}\sum_{S_{i}}\delta[\boldsymbol{q}-(S_{i}\boldsymbol{k}_{i}^{\prime}-\boldsymbol{k}_{j})+\boldsymbol{G}]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Note that the integral
\begin_inset Formula 
\begin{eqnarray}
\sum_{nn^{\prime}}\int{\rm d}^{3}q\chi_{nn^{\prime}}(\boldsymbol{q}) & = & \sum_{nn^{\prime}}\int{\rm d}^{3}q\int_{{\rm BZ}}{\rm d}^{3}k\delta(\varepsilon_{\boldsymbol{k}n}-\varepsilon_{F})\delta(\varepsilon_{\boldsymbol{k}+\boldsymbol{q}n^{\prime}}-\varepsilon_{F})\\
 & = & \sum_{n}\int_{{\rm BZ}}{\rm d}^{3}k\delta(\varepsilon_{\boldsymbol{k}n}-\varepsilon_{F})\sum_{n^{\prime}}\int{\rm d}^{3}q\delta(\varepsilon_{\boldsymbol{q}n^{\prime}}-\varepsilon_{F})\\
 &  & \equiv\rho(\varepsilon_{F})^{2}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Subsection
Sum rules
\end_layout

\begin_layout Standard
If the entire lattice is shifted in a given direction, the potential is
 the same as the unperturbed, except that the unit cell frame is shifted.
 This implies
\begin_inset Formula 
\begin{eqnarray}
\int{\rm d}\boldsymbol{r}\sum_{i}\nabla_{(\boldsymbol{0}ix_{i})}v_{{\rm {\scriptscriptstyle scf}}}(\boldsymbol{r}) & = & \int{\rm d}\boldsymbol{r}\lim_{\Delta\rightarrow0}\frac{v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r})-\sum_{i}v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}+\Delta\underbar{v}_{\boldsymbol{0}ix_{i}}](\boldsymbol{r})}{\Delta}\\
 & = & \int{\rm d}\boldsymbol{r}\lim_{\Delta\rightarrow0}\frac{v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r})-v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}+\sum_{i}\Delta\underbar{v}_{\boldsymbol{0}ix_{i}}](\boldsymbol{r})}{\Delta}\\
 & = & \lim_{\Delta\rightarrow0}\frac{1}{\Delta}\{\int v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r}){\rm d}\boldsymbol{r}-\int v_{{\rm {\scriptscriptstyle scf}}}[\underbar{R}](\boldsymbol{r}-\Delta\sum_{i}\underbar{v}_{\boldsymbol{0}ix_{i}}){\rm d}\boldsymbol{r}\}\\
 & = & 0
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{widetext}
\end_layout

\end_inset


\end_layout

\end_body
\end_document
